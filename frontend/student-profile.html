<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>UniTalent – Student Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body {
      position: relative;
      overflow-x: hidden;
      background: #020617;
    }

    .animated-bg {
      position: fixed;
      inset: 0;
      z-index: -10;
      pointer-events: none;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      overflow: hidden;
    }

    .animated-bg::before {
      content: "";
      position: absolute;
      left: -50%;
      bottom: -40%;
      width: 200%;
      height: 200%;
      background-image: radial-gradient(#64748b 1px, transparent 1px);
      background-size: 26px 26px;
      opacity: 0.6;
      transform-origin: center;
      transform: perspective(900px) rotateX(72deg) translateY(0);
      animation: moveGrid 18s linear infinite;
    }

    @keyframes moveGrid {
      0% {
        transform: perspective(900px) rotateX(72deg) translateY(0);
      }

      100% {
        transform: perspective(900px) rotateX(72deg) translateY(140px);
      }
    }
  </style>
</head>

<body class="font-sans text-slate-100" data-guard="STUDENT">
  <div class="animated-bg"></div>

  <!-- Header -->
  <header class="sticky top-0 z-20 border-b border-slate-800/60 bg-slate-950/80 backdrop-blur">
    <nav class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3 md:py-4">
      <a href="index.html" class="flex items-center gap-2">
        <div
          class="flex h-10 w-10 items-center justify-center rounded-2xl bg-slate-900/60 shadow-lg shadow-indigo-500/40">
          <img src="assets/logo.png" alt="UniTalent logo" class="h-8 w-8 object-contain" />
        </div>
        <div class="leading-tight">
          <p class="text-base font-semibold tracking-tight">UniTalent</p>
          <p class="text-[11px] text-slate-400">Student Career Platform</p>
        </div>
      </a>

      <div class="hidden items-center gap-6 text-sm font-medium text-slate-200 md:flex">
        <a href="index.html#how" class="hover:text-indigo-300">How it works</a>
        <a href="jobs.html" class="hover:text-indigo-300">Jobs</a>
        <a href="student-dashboard.html" class="text-indigo-300">For students</a>
        <a href="employer-login.html" class="hover:text-indigo-300">For employers</a>
        <a href="index.html#about" class="hover:text-indigo-300">About</a>
      </div>

      <div class="hidden items-center gap-3 md:flex">
        <span class="text-xs text-slate-400">Logged in as</span>
        <span id="nav-user-pill" class="rounded-full bg-slate-900 px-3 py-1 text-xs font-semibold text-slate-100">
          Student
        </span>

        <button id="logout-btn"
          class="rounded-full bg-slate-900/80 px-3 py-1 text-[11px] font-semibold text-slate-200 ring-1 ring-slate-700 hover:ring-rose-400">
          Logout
        </button>
      </div>

      <button
        class="inline-flex items-center justify-center rounded-full border border-slate-700 p-2 text-slate-200 md:hidden">
        <span class="sr-only">Open menu</span>
        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </nav>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-6xl px-4 pb-16 pt-6 md:pt-8">
    <!-- Breadcrumbs -->
    <div class="mb-4 text-xs text-slate-400">
      <a href="index.html" class="hover:text-indigo-300">Home</a>
      <span class="mx-1 text-slate-500">/</span>
      <a href="student-dashboard.html" class="hover:text-indigo-300">Dashboard</a>
      <span class="mx-1 text-slate-500">/</span>
      <span class="text-slate-300">Profile</span>
    </div>

    <!-- Title -->
    <section class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div>
        <p class="text-xs text-slate-400">Student profile</p>
        <h1 class="text-2xl font-bold tracking-tight text-slate-50 sm:text-3xl">
          Edit your profile
        </h1>
        <p class="mt-1 text-sm text-slate-400">
          Keep your information updated to get better job matches.
        </p>
      </div>

      <div class="flex items-center gap-2">
        <a href="student-dashboard.html"
          class="rounded-full bg-slate-900/80 px-4 py-2 text-[11px] font-semibold text-slate-200 ring-1 ring-slate-700 hover:ring-indigo-400">
          ← Back to dashboard
        </a>
        <button id="save-top-btn" type="button"
          class="rounded-full bg-indigo-500 px-4 py-2 text-[11px] font-semibold text-white hover:bg-indigo-400">
          Save changes
        </button>
      </div>
    </section>

    <!-- Status line -->
    <div id="page-status" class="mt-4 text-[11px] text-slate-400">
      Loading your profile...
    </div>

    <!-- Form Card -->
    <section class="mt-4 rounded-3xl border border-slate-800 bg-slate-900/80 p-5 shadow-xl shadow-slate-900/70">
      <form id="profile-form" class="grid gap-6">

        <!-- Basic -->
        <div>
          <h2 class="text-sm font-semibold text-slate-50">Basic information</h2>
          <p class="mt-1 text-[11px] text-slate-400">This is used for your public student profile.</p>

          <div class="mt-4 grid gap-3 md:grid-cols-2">
            <div>
              <label class="text-[11px] text-slate-300">First name</label>
              <input id="firstName" type="text"
                class="mt-1 w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 outline-none focus:border-indigo-400"
                placeholder="John" />
            </div>
            <div>
              <label class="text-[11px] text-slate-300">Last name</label>
              <input id="lastName" type="text"
                class="mt-1 w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 outline-none focus:border-indigo-400"
                placeholder="Doe" />
            </div>

            <div>
              <label class="text-[11px] text-slate-300">Phone</label>
              <input id="phone" type="text"
                class="mt-1 w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 outline-none focus:border-indigo-400"
                placeholder="+7 7xx xxx xx xx" />
            </div>

            <div>
              <label class="text-[11px] text-slate-300">City</label>
              <input id="city" type="text"
                class="mt-1 w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 outline-none focus:border-indigo-400"
                placeholder="Almaty" />
            </div>
          </div>
        </div>

        <div class="h-px bg-slate-800"></div>

        <!-- Education -->
        <div>
          <h2 class="text-sm font-semibold text-slate-50">Education</h2>
          <p class="mt-1 text-[11px] text-slate-400">Helps employers understand your academic background.</p>

          <div class="mt-4 grid gap-3 md:grid-cols-2">
            <div>
              <label class="text-[11px] text-slate-300">University</label>
              <input id="university" type="text"
                class="mt-1 w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 outline-none focus:border-indigo-400"
                placeholder="SDU" />
            </div>
            <div>
              <label class="text-[11px] text-slate-300">Major</label>
              <input id="major" type="text"
                class="mt-1 w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 outline-none focus:border-indigo-400"
                placeholder="Information Systems" />
            </div>

            <div>
              <label class="text-[11px] text-slate-300">Study year</label>
              <input id="studyYear" type="text"
                class="mt-1 w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 outline-none focus:border-indigo-400"
                placeholder="2nd year" />
            </div>
          </div>
        </div>

        <div class="h-px bg-slate-800"></div>

        <!-- Skills & Bio -->
        <div>
          <h2 class="text-sm font-semibold text-slate-50">Skills & bio</h2>
          <p class="mt-1 text-[11px] text-slate-400">Use comma-separated skills.</p>

          <div class="mt-4 grid gap-3">
            <div>
              <label class="text-[11px] text-slate-300">Skills</label>
              <input id="skills" type="text"
                class="mt-1 w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 outline-none focus:border-indigo-400"
                placeholder="HTML, CSS, JavaScript, React" />
            </div>

            <div>
              <label class="text-[11px] text-slate-300">Short bio</label>
              <textarea id="bio" rows="4"
                class="mt-1 w-full resize-none rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 outline-none focus:border-indigo-400"
                placeholder="Tell employers about your goals, strengths, and projects..."></textarea>
            </div>
          </div>
        </div>

        <div class="h-px bg-slate-800"></div>

        <!-- Links -->
        <div>
          <h2 class="text-sm font-semibold text-slate-50">Links</h2>
          <p class="mt-1 text-[11px] text-slate-400">Optional, but improves credibility.</p>

          <div class="mt-4 grid gap-3 md:grid-cols-2">
            <div>
              <label class="text-[11px] text-slate-300">GitHub</label>
              <input id="github" type="text"
                class="mt-1 w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 outline-none focus:border-indigo-400"
                placeholder="https://github.com/username" />
            </div>
            <div>
              <label class="text-[11px] text-slate-300">LinkedIn</label>
              <input id="linkedin" type="text"
                class="mt-1 w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 outline-none focus:border-indigo-400"
                placeholder="https://linkedin.com/in/username" />
            </div>
            <div class="md:col-span-2">
              <label class="text-[11px] text-slate-300">Portfolio</label>
              <input id="portfolio" type="text"
                class="mt-1 w-full rounded-2xl border border-slate-800 bg-slate-950/60 px-3 py-2 text-xs text-slate-100 outline-none focus:border-indigo-400"
                placeholder="https://your-portfolio.com" />
            </div>
          </div>
        </div>

        <!-- Bottom actions -->
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <p class="text-[10px] text-slate-500">
            Your changes will update dashboard name + profile completeness.
          </p>
          <div class="flex gap-2">
            <button type="button" id="reset-btn"
              class="rounded-full bg-slate-900/80 px-4 py-2 text-[11px] font-semibold text-slate-200 ring-1 ring-slate-700 hover:ring-slate-500">
              Reset
            </button>
            <button type="submit" id="save-btn"
              class="rounded-full bg-indigo-500 px-5 py-2 text-[11px] font-semibold text-white hover:bg-indigo-400">
              Save changes
            </button>
          </div>
        </div>

      </form>
    </section>
  </main>

  <footer class="border-t border-slate-800 bg-slate-950/90">
    <div
      class="mx-auto flex max-w-6xl flex-col gap-3 px-4 py-5 text-xs text-slate-500 md:flex-row md:items-center md:justify-between">
      <p>© 2025 UniTalent. All rights reserved.</p>
      <div class="flex flex-wrap gap-4">
        <a href="index.html#about" class="hover:text-indigo-300">About</a>
        <a href="index.html#contact" class="hover:text-indigo-300">Contact</a>
        <span>Terms · Privacy</span>
      </div>
    </div>
  </footer>

  <!-- Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const API = 'http://localhost:3000';

      // -------------------------
      // ✅ Unified storage helpers (same logic as dashboard/auth.js)
      // -------------------------
      const storeGet = (key) =>
        localStorage.getItem(key) ?? sessionStorage.getItem(key);

      const storeRemove = (key) => {
        localStorage.removeItem(key);
        sessionStorage.removeItem(key);
      };

      function getToken() {
        return storeGet('unitalent_token');
      }

      function getUser() {
        try {
          const raw = storeGet('unitalent_user');
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      }

      function clearAuth() {
        storeRemove('unitalent_token');
        storeRemove('unitalent_user');

        // optional: clean extra keys too
        [
          'unitalent_student_name',
          'unitalent_student_email',
          'unitalent_student_username',
          'unitalent_employer_name',
          'unitalent_employer_bin',
          'unitalent_employer_city',
          'unitalent_employer_size',
          'unitalent_student_profile'
        ].forEach(storeRemove);
      }

      // -------------------------
      // ✅ Local profile fallback (MUST HAVE for code below)
      // -------------------------
      function getLocalProfile() {
        try {
          return JSON.parse(localStorage.getItem('unitalent_student_profile') || 'null');
        } catch {
          return null;
        }
      }

      function setLocalProfile(p) {
        localStorage.setItem('unitalent_student_profile', JSON.stringify(p || {}));
      }

      // -------------------------
      // Auth guard
      // -------------------------
      const token = getToken();
      let user = getUser();

      if (!token || !user) {
        clearAuth();
        window.location.href = 'student-login.html';
        return;
      }

      if (user.role !== 'STUDENT') {
        window.location.href =
          user.role === 'EMPLOYER'
            ? 'employer-login.html'
            : 'student-login.html';
        return;
      }

      // -------------------------
      // UI refs
      // -------------------------
      const statusEl = document.getElementById('page-status');
      const navUserPill = document.getElementById('nav-user-pill');
      const logoutBtn = document.getElementById('logout-btn');

      const form = document.getElementById('profile-form');
      const saveBtn = document.getElementById('save-btn');
      const saveTopBtn = document.getElementById('save-top-btn');
      const resetBtn = document.getElementById('reset-btn');

      const fields = {
        firstName: document.getElementById('firstName'),
        lastName: document.getElementById('lastName'),
        phone: document.getElementById('phone'),
        university: document.getElementById('university'),
        major: document.getElementById('major'),
        studyYear: document.getElementById('studyYear'),
        city: document.getElementById('city'),
        skills: document.getElementById('skills'),
        bio: document.getElementById('bio'),
        github: document.getElementById('github'),
        linkedin: document.getElementById('linkedin'),
        portfolio: document.getElementById('portfolio')
      };

      // -------------------------
      // Helpers
      // -------------------------
      function buildFullName(p) {
        return (
          [p?.firstName, p?.lastName].filter(Boolean).join(' ') ||
          [user?.firstName, user?.lastName].filter(Boolean).join(' ') ||
          user?.email ||
          'Student'
        );
      }

      function setNavName(p) {
        if (navUserPill) navUserPill.textContent = buildFullName(p);
      }

      function setField(el, value) {
        if (!el) return;
        el.value = value ?? '';
      }

      // -------------------------
      // Fill form
      // -------------------------
      function fillForm(p = {}) {
        setField(fields.firstName, p.firstName);
        setField(fields.lastName, p.lastName);
        setField(fields.phone, p.phone);
        setField(fields.university, p.university);
        setField(fields.major, p.major);
        setField(fields.studyYear, p.studyYear);
        setField(fields.city, p.city);
        setField(fields.skills, p.skills);
        setField(fields.bio, p.bio);
        setField(fields.github, p.github);
        setField(fields.linkedin, p.linkedin);
        setField(fields.portfolio, p.portfolio);
        setNavName(p);
      }

      // -------------------------
      // Read form
      // -------------------------
      function readForm() {
        return {
          firstName: fields.firstName?.value.trim() || '',
          lastName: fields.lastName?.value.trim() || '',
          phone: fields.phone?.value.trim() || '',
          university: fields.university?.value.trim() || '',
          major: fields.major?.value.trim() || '',
          studyYear: fields.studyYear?.value.trim() || '',
          city: fields.city?.value.trim() || '',
          skills: fields.skills?.value.trim() || '',
          bio: fields.bio?.value.trim() || '',
          github: fields.github?.value.trim() || '',
          linkedin: fields.linkedin?.value.trim() || '',
          portfolio: fields.portfolio?.value.trim() || ''
        };
      }

      function disableSaveButtons(flag) {
        if (saveBtn) saveBtn.disabled = flag;
        if (saveTopBtn) saveTopBtn.disabled = flag;
      }

      // -------------------------
      // Load profile
      // -------------------------
      async function loadProfile() {
        const local = getLocalProfile() || {};

        // First render something immediately
        fillForm({
          ...local,
          firstName: local.firstName ?? user.firstName ?? '',
          lastName: local.lastName ?? user.lastName ?? ''
        });

        try {
          if (statusEl) statusEl.textContent = 'Loading from backend...';

          const res = await fetch(`${API}/api/students/me`, {
            headers: { 'Authorization': 'Bearer ' + token }
          });

          if (res.status === 401) {
            clearAuth();
            window.location.href = 'student-login.html';
            return;
          }

          const data = await res.json().catch(() => null);
          if (!res.ok) throw new Error(data?.message || 'Failed to load profile');

          const merged = { ...local, ...data };

          setLocalProfile(merged);
          fillForm(merged);

          if (statusEl) statusEl.textContent = 'Profile loaded.';
        } catch (e) {
          console.warn(e);
          if (statusEl) statusEl.textContent = 'Using local profile (backend not available).';
        }
      }

      // -------------------------
      // Save profile
      // -------------------------
      async function saveProfile() {
        const payload = readForm();

        try {
          if (statusEl) statusEl.textContent = 'Saving...';
          disableSaveButtons(true);

          const res = await fetch(`${API}/api/students/me`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(payload)
          });

          if (res.status === 401) {
            clearAuth();
            window.location.href = 'student-login.html';
            return;
          }

          const data = await res.json().catch(() => null);
          if (!res.ok) throw new Error(data?.message || 'Failed to save profile');

          // ✅ Save local profile
          setLocalProfile(data);

          // ✅ Update shared user object for dashboard greeting
          const updatedUser = {
            ...user,
            firstName: data.firstName ?? user.firstName,
            lastName: data.lastName ?? user.lastName
          };
          user = updatedUser;
          localStorage.setItem('unitalent_user', JSON.stringify(updatedUser));

          setNavName(data);

          if (statusEl) statusEl.textContent = '✅ Changes saved successfully.';
        } catch (e) {
          console.error(e);

          // fallback local save so UI still works
          const localFallback = { ...(getLocalProfile() || {}), ...payload };
          setLocalProfile(localFallback);
          setNavName(localFallback);

          if (statusEl) statusEl.textContent = '❌ Save failed (stored locally): ' + e.message;
        } finally {
          disableSaveButtons(false);
        }
      }

      // -------------------------
      // Reset
      // -------------------------
      function resetForm() {
        const local = getLocalProfile() || {};
        fillForm({
          ...local,
          firstName: local.firstName ?? user.firstName ?? '',
          lastName: local.lastName ?? user.lastName ?? ''
        });
        if (statusEl) statusEl.textContent = 'Form reset to last saved state.';
      }

      // -------------------------
      // Logout
      // -------------------------
      logoutBtn?.addEventListener('click', () => {
        clearAuth();
        window.location.href = 'index.html';
      });

      // -------------------------
      // Events
      // -------------------------
      form?.addEventListener('submit', (e) => {
        e.preventDefault();
        saveProfile();
      });

      saveTopBtn?.addEventListener('click', () => saveProfile());
      resetBtn?.addEventListener('click', () => resetForm());

      // Init
      setNavName(getLocalProfile());
      loadProfile();
    });
  </script>

  <script type="module" src="js/auth.js"></script>

</body>

</html>