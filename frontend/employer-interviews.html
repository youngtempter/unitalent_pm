<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UniTalent – Employer Interviews</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
        }
      }
    }
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body class="font-sans bg-slate-950 text-slate-100" data-guard="EMPLOYER">
  <!-- Background blobs -->
  <div class="pointer-events-none fixed inset-0 -z-10">
    <div class="absolute -top-40 -left-32 h-72 w-72 rounded-full bg-indigo-500/40 blur-3xl"></div>
    <div class="absolute top-40 -right-20 h-80 w-80 rounded-full bg-emerald-500/30 blur-3xl"></div>
  </div>

  <!-- NAVBAR -->
  <header class="sticky top-0 z-20 border-b border-slate-800/60 bg-slate-950/80 backdrop-blur">
    <nav class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3 md:py-4">
      <a href="index.html" class="flex items-center gap-2">
        <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-slate-900/60 shadow-lg shadow-indigo-500/40">
          <img src="assets/logo.png" alt="UniTalent logo" class="h-8 w-8 object-contain" />
        </div>
        <div class="leading-tight">
          <p class="text-base font-semibold tracking-tight">UniTalent</p>
          <p class="text-[11px] text-slate-400">Employer Panel</p>
        </div>
      </a>

      <div class="hidden items-center gap-6 text-sm font-medium text-slate-200 md:flex">
        <a href="jobs.html" class="hover:text-indigo-300">Jobs</a>
        <a href="employer-dashboard.html" class="hover:text-indigo-300">Dashboard</a>
        <a href="employer-interviews.html" class="text-indigo-300">Interviews</a>
      </div>

      <div class="hidden items-center gap-3 md:flex">
        <span class="text-xs text-slate-400">Logged in as</span>
        <span id="nav-user-pill" class="rounded-full bg-slate-900 px-3 py-1 text-xs font-semibold text-slate-100">
          Employer
        </span>
        <button id="logout-btn"
          class="rounded-full bg-slate-900/80 px-3 py-1 text-[11px] font-semibold text-slate-200 ring-1 ring-slate-700 hover:ring-rose-400">
          Logout
        </button>
      </div>
    </nav>
  </header>

  <main class="mx-auto max-w-6xl px-4 pb-16 pt-8">
    <!-- Breadcrumb -->
    <div class="mb-4 text-xs text-slate-400">
      <a href="index.html" class="hover:text-indigo-300">Home</a>
      <span class="mx-1 text-slate-500">/</span>
      <a href="employer-dashboard.html" class="hover:text-indigo-300">Employer dashboard</a>
      <span class="mx-1 text-slate-500">/</span>
      <span class="text-slate-300">Interviews</span>
    </div>

    <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
      <div>
        <h1 class="text-2xl font-bold tracking-tight text-slate-50 sm:text-3xl">
          Interview candidates
        </h1>
        <p class="mt-1 text-sm text-slate-400">
          Simple list of students marked as INTERVIEW for your jobs.
        </p>
      </div>

      <div id="statusPill" class="flex items-center gap-2 text-xs text-slate-400">
        <span class="inline-flex h-2 w-2 rounded-full bg-slate-500"></span>
        <span>Loading interviews...</span>
      </div>
    </div>

    <section class="mt-6">
      <div class="flex items-center justify-between text-xs text-slate-400">
        <p>
          Total interviews:
          <span id="count" class="font-semibold text-slate-200">0</span>
        </p>
        <div class="flex gap-2">
          <a href="employer-dashboard.html"
             class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 hover:border-indigo-400 hover:text-indigo-200">
            ← Back to dashboard
          </a>
        </div>
      </div>

      <div id="list" class="mt-4 space-y-3"></div>
    </section>
  </main>

  <footer class="border-t border-slate-800 bg-slate-950/90">
    <div class="mx-auto flex max-w-6xl flex-col gap-3 px-4 py-5 text-xs text-slate-500 md:flex-row md:items-center md:justify-between">
      <p>© 2025 UniTalent. All rights reserved.</p>
      <div class="flex flex-wrap gap-4">
        <a href="index.html#about" class="hover:text-indigo-300">About</a>
        <a href="index.html#contact" class="hover:text-indigo-300">Contact</a>
        <span>Terms · Privacy</span>
      </div>
    </div>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const API = "http://localhost:3000";

      // -------------------------
      // Auth helpers (same style)
      // -------------------------
      const storeGet = (key) =>
        localStorage.getItem(key) ?? sessionStorage.getItem(key);

      const storeRemove = (key) => {
        localStorage.removeItem(key);
        sessionStorage.removeItem(key);
      };

      function readUniTalentAuth() {
        const token = storeGet("unitalent_token");
        const userRaw = storeGet("unitalent_user");
        if (!token || !userRaw) return { token: null, user: null };

        try {
          return { token, user: JSON.parse(userRaw) };
        } catch {
          storeRemove("unitalent_token");
          storeRemove("unitalent_user");
          return { token: null, user: null };
        }
      }

      function clearAllAuth() {
        ["unitalent_token", "unitalent_user"].forEach(storeRemove);
      }

      const { token, user } = readUniTalentAuth();

      if (!token || !user) {
        clearAllAuth();
        window.location.href = "employer-login.html";
        return;
      }

      if (user.role !== "EMPLOYER") {
        window.location.href =
          user.role === "STUDENT"
            ? "student-dashboard.html"
            : "index.html";
        return;
      }

      // -------------------------
      // UI nodes
      // -------------------------
      const navUserPill = document.getElementById("nav-user-pill");
      const logoutBtn = document.getElementById("logout-btn");
      const statusPill = document.getElementById("statusPill");
      const list = document.getElementById("list");
      const count = document.getElementById("count");

      const employerName =
        [user.firstName, user.lastName].filter(Boolean).join(" ") ||
        user.email ||
        "Employer";

      if (navUserPill) navUserPill.textContent = employerName;

      logoutBtn?.addEventListener("click", () => {
        clearAllAuth();
        window.location.href = "index.html";
      });

      function setStatus(ok, text) {
        if (!statusPill) return;
        statusPill.innerHTML = `
          <span class="inline-flex h-2 w-2 rounded-full ${ok ? "bg-emerald-400" : "bg-rose-400"}"></span>
          <span>${text}</span>
        `;
      }

      function escapeHtml(str = "") {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function render(items = []) {
        if (count) count.textContent = String(items.length);
        if (!list) return;

        if (!items.length) {
          list.innerHTML = `
            <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-6 text-sm text-slate-300">
              No interview candidates yet.
            </div>
          `;
          return;
        }

        list.innerHTML = items.map(app => {
          const job = app.job || {};
          const st = app.student || {};

          const title = escapeHtml(job.title || "Untitled job");
          const location = escapeHtml(job.location || "Location not specified");

          const studentName =
            escapeHtml([st.firstName, st.lastName].filter(Boolean).join(" ") || st.email || "Student");

          const major = escapeHtml(st.major || "Major not specified");
          const uni = escapeHtml(st.university || "University not specified");
          const skills = escapeHtml(st.skills || "");

          return `
            <article class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 shadow-lg shadow-slate-900/60">
              <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
                <div class="space-y-1">
                  <p class="text-[11px] uppercase tracking-wide text-emerald-400">
                    Interview · ${title}
                  </p>
                  <h3 class="text-sm font-semibold text-slate-50">${studentName}</h3>
                  <p class="text-xs text-slate-400">${uni} · ${major}</p>
                  <p class="text-[11px] text-slate-500">${location}</p>

                  ${skills ? `
                    <p class="mt-2 text-[11px] text-slate-300">
                      <span class="text-slate-400">Skills:</span> ${skills}
                    </p>
                  ` : ""}
                </div>

                <div class="flex flex-col items-end gap-2 text-xs">
                  <span class="rounded-full bg-slate-800 px-2 py-1 text-[10px] font-medium text-slate-200">
                    Status: ${escapeHtml(app.status || "INTERVIEW")}
                  </span>

                  <div class="flex gap-2">
                    <button
                      class="js-status rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1.5 text-[11px] text-slate-200 hover:border-rose-400 hover:text-rose-200"
                      data-id="${app.id}"
                      data-status="REJECTED">
                      Reject
                    </button>
                    <button
                      class="js-status rounded-full bg-emerald-500 px-3 py-1.5 text-[11px] font-semibold text-white hover:bg-emerald-400"
                      data-id="${app.id}"
                      data-status="HIRED">
                      Hire
                    </button>
                  </div>
                </div>
              </div>
            </article>
          `;
        }).join("");
      }

      async function loadInterviews() {
        try {
          setStatus(true, "Loading interviews...");
          const res = await fetch(`${API}/api/applications/employer?status=INTERVIEW`, {
            headers: { Authorization: "Bearer " + token }
          });

          if (res.status === 401) {
            clearAllAuth();
            window.location.href = "employer-login.html";
            return;
          }

          const data = await res.json().catch(() => []);
          if (!res.ok) throw new Error(data?.message || "Failed to load interviews");

          const items = Array.isArray(data) ? data : [];
          render(items);
          setStatus(true, `Loaded ${items.length} interview candidates`);
        } catch (err) {
          console.error(err);
          render([]);
          setStatus(false, err.message);
        }
      }

      // Update status handler
      list?.addEventListener("click", async (e) => {
        const btn = e.target.closest(".js-status");
        if (!btn) return;

        const id = Number(btn.dataset.id);
        const status = btn.dataset.status;

        if (!id || !status) return;

        const oldText = btn.textContent;
        btn.disabled = true;
        btn.classList.add("opacity-60");

        try {
          const res = await fetch(`${API}/api/applications/${id}/status`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token
            },
            body: JSON.stringify({ status })
          });

          if (res.status === 401) {
            clearAllAuth();
            window.location.href = "employer-login.html";
            return;
          }

          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data?.message || "Failed to update status");

          setStatus(true, `Status updated → ${status}`);
          // reload interviews (if hired/rejected, it disappears)
          loadInterviews();
        } catch (err) {
          console.error(err);
          setStatus(false, err.message);
          btn.textContent = oldText;
        } finally {
          btn.disabled = false;
          btn.classList.remove("opacity-60");
        }
      });

      loadInterviews();
    });
  </script>

  <script type="module" src="js/auth.js"></script>
</body>
</html>
    