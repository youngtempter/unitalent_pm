<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>UniTalent – Post a New Job</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body class="font-sans bg-slate-950 text-slate-100" data-guard="EMPLOYER">
  <!-- Background gradient blobs -->
  <div class="pointer-events-none fixed inset-0 -z-10">
    <div class="absolute -top-40 -left-32 h-72 w-72 rounded-full bg-indigo-500/40 blur-3xl"></div>
    <div class="absolute top-40 -right-20 h-80 w-80 rounded-full bg-emerald-500/30 blur-3xl"></div>
  </div>

  <!-- NAVBAR -->
  <header class="sticky top-0 z-20 border-b border-slate-800/60 bg-slate-950/80 backdrop-blur">
    <nav class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3 md:py-4">
      <!-- Logo -->
      <a href="index.html" class="flex items-center gap-2">
        <div
          class="flex h-10 w-10 items-center justify-center rounded-2xl bg-slate-900/60 shadow-lg shadow-indigo-500/40">
          <img src="assets/logo.png" alt="UniTalent logo" class="h-8 w-8 object-contain" />
        </div>
        <div class="leading-tight">
          <p class="text-base font-semibold tracking-tight">UniTalent</p>
          <p class="text-[11px] text-slate-400">Employer Portal</p>
        </div>
      </a>

      <!-- Desktop menu -->
      <div class="hidden items-center gap-6 text-sm font-medium text-slate-200 md:flex">
        <a href="jobs.html" class="hover:text-indigo-300">Browse jobs</a>
        <a href="employer-new-job.html" class="text-indigo-300">Post a job</a>
        <a href="employer-login.html" class="hover:text-indigo-300">Employer login</a>
      </div>

      <!-- Right side -->
      <div class="hidden items-center gap-3 md:flex">
        <button id="logoutBtn"
          class="rounded-full border border-slate-700 bg-slate-950/60 px-4 py-2 text-xs font-semibold text-slate-200 hover:border-rose-400 hover:text-rose-200">
          Log out
        </button>
      </div>

      <!-- Mobile menu button (visual only) -->
      <button
        class="inline-flex items-center justify-center rounded-full border border-slate-700 p-2 text-slate-200 md:hidden">
        <span class="sr-only">Open menu</span>
        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </nav>
  </header>

  <main class="mx-auto max-w-6xl px-4 pb-16 pt-8 md:pt-10">
    <!-- Breadcrumb -->
    <div class="mb-4 text-xs text-slate-400">
      <a href="index.html" class="hover:text-indigo-300">Home</a>
      <span class="mx-1 text-slate-500">/</span>
      <span class="text-slate-300">Employer</span>
      <span class="mx-1 text-slate-500">/</span>
      <span class="text-slate-300">Post new job</span>
    </div>

    <!-- Header -->
    <section class="mb-6">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div class="flex items-center gap-3">
          <a href="employer-dashboard.html"
            class="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-900/70 px-3 py-1.5 text-[11px] font-semibold text-slate-200 hover:border-indigo-400 hover:text-indigo-200">
            ← Back to Dashboard
          </a>
          <div>
            <h1 class="text-2xl font-bold tracking-tight text-slate-50 sm:text-3xl">
              Post a new job
            </h1>
            <p class="mt-1 text-sm text-slate-400">
              Create an internship or entry-level role for students and fresh graduates.
            </p>
          </div>
        </div>

        <!-- Status -->
        <div id="authStatus" class="flex items-center gap-2 text-xs text-slate-400">
          <span class="inline-flex h-2 w-2 rounded-full bg-slate-500"></span>
          <span>Checking employer authentication...</span>
        </div>
      </div>
    </section>

    <!-- Layout -->
    <section class="grid gap-6 md:grid-cols-[minmax(0,1.6fr),minmax(0,1fr)]">
      <!-- Form Card -->
      <div class="rounded-3xl border border-slate-800 bg-slate-900/80 p-5 shadow-xl shadow-slate-900/70">
        <form id="jobForm" class="space-y-4">
          <!-- Title -->
          <div>
            <label class="mb-1 block text-xs font-medium text-slate-300">Job title *</label>
            <input id="titleInput" type="text" maxlength="120" placeholder="e.g. Junior Frontend Intern"
              class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:outline-none" />
            <p class="mt-1 text-[11px] text-slate-500">Short, clear title increases applications.</p>
          </div>

          <!-- Description -->
          <div>
            <label class="mb-1 block text-xs font-medium text-slate-300">Description *</label>
            <textarea id="descInput" rows="6" maxlength="3000"
              placeholder="Describe responsibilities, requirements, what students will learn..."
              class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:outline-none"></textarea>
            <p class="mt-1 text-[11px] text-slate-500">Be specific about skills and internship duration if relevant.</p>
          </div>

          <!-- Location + Type + WorkMode + Salary -->
          <div class="grid gap-3 md:grid-cols-2">
            <div>
              <label class="mb-1 block text-xs font-medium text-slate-300">Location</label>
              <input id="locationInput" type="text" maxlength="120" placeholder="e.g. Almaty · Hybrid"
                class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:outline-none" />
            </div>
            <div>
              <label class="mb-1 block text-xs font-medium text-slate-300">Type</label>
              <select id="typeInput"
                class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-indigo-500 focus:outline-none">
                <option value="">Not specified</option>
                <option value="INTERNSHIP">Internship</option>
                <option value="PART_TIME">Part-time</option>
                <option value="FULL_TIME">Full-time</option>
              </select>
            </div>
            <div>
              <label class="mb-1 block text-xs font-medium text-slate-300">Work mode</label>
              <select id="workModeInput"
                class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-indigo-500 focus:outline-none">
                <option value="">Not specified</option>
                <option value="ON_SITE">On-site</option>
                <option value="HYBRID">Hybrid</option>
                <option value="REMOTE">Remote</option>
              </select>
            </div>
            <div>
              <label class="mb-1 block text-xs font-medium text-slate-300">Salary / Stipend (optional)</label>
              <input id="salaryInput" type="text" maxlength="120" placeholder="e.g. 200 000 KZT / month"
                class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:outline-none" />
            </div>
          </div>

          <!-- Requirements -->
          <div>
            <label class="mb-1 block text-xs font-medium text-slate-300">Requirements (optional)</label>
            <textarea id="requirementsInput" rows="3" maxlength="2000"
              placeholder="e.g. 2nd–4th year student, basic JS, Git, English B1+"
              class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:outline-none"></textarea>
            <p class="mt-1 text-[11px] text-slate-500">List specific skills, experience level, or prerequisites.</p>
          </div>

          <!-- Application Deadline + Job Expiration -->
          <div class="grid gap-3 md:grid-cols-2">
            <div>
              <label class="mb-1 block text-xs font-medium text-slate-300">Application Deadline (optional)</label>
              <input id="applicationDeadlineInput" type="datetime-local"
                class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-indigo-500 focus:outline-none" />
              <p class="mt-1 text-[11px] text-slate-500">When applications close</p>
            </div>
            <div>
              <label class="mb-1 block text-xs font-medium text-slate-300">Job Expiration (optional)</label>
              <input id="expiresAtInput" type="datetime-local"
                class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-indigo-500 focus:outline-none" />
              <p class="mt-1 text-[11px] text-slate-500">When job listing expires</p>
            </div>
          </div>

          <!-- Inline form message -->
          <div id="formMsg" class="hidden rounded-2xl border px-3 py-2 text-xs"></div>

          <!-- Buttons -->
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
            <button id="submitBtn" type="submit"
              class="inline-flex items-center justify-center rounded-full bg-indigo-500 px-5 py-2.5 text-sm font-semibold text-white shadow-md shadow-indigo-500/40 hover:bg-indigo-400 disabled:cursor-not-allowed disabled:opacity-60">
              Publish job
            </button>

            <a href="jobs.html"
              class="inline-flex items-center justify-center rounded-full border border-slate-700 bg-slate-950/60 px-5 py-2.5 text-sm font-semibold text-slate-200 hover:border-indigo-400 hover:text-indigo-200">
              View jobs list
            </a>
          </div>
        </form>
      </div>

      <!-- Side Info -->
      <aside class="space-y-4">
        <div class="rounded-3xl border border-slate-800 bg-slate-900/80 p-4 shadow-lg shadow-slate-900/70">
          <h3 class="text-sm font-semibold text-slate-50">Recommended structure</h3>
          <ul class="mt-3 space-y-1.5 text-xs text-slate-300">
            <li>• What the student will build or learn</li>
            <li>• Required skills (keep beginner friendly)</li>
            <li>• Duration and format (remote/hybrid)</li>
            <li>• Salary/stipend if available</li>
          </ul>
        </div>
      </aside>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="border-t border-slate-800 bg-slate-950/90">
    <div
      class="mx-auto flex max-w-6xl flex-col gap-3 px-4 py-5 text-xs text-slate-500 md:flex-row md:items-center md:justify-between">
      <p>© 2025 UniTalent. All rights reserved.</p>
      <div class="flex flex-wrap gap-4">
        <a href="index.html#about" class="hover:text-indigo-300">About</a>
        <a href="index.html#contact" class="hover:text-indigo-300">Contact</a>
        <span>Terms · Privacy</span>
      </div>
    </div>
  </footer>

  <!-- JS -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const API = 'http://localhost:3000';

      const authStatus = document.getElementById('authStatus');
      const logoutBtn = document.getElementById('logoutBtn');

      const jobForm = document.getElementById('jobForm');
      const submitBtn = document.getElementById('submitBtn');

      const titleInput = document.getElementById('titleInput');
      const descInput = document.getElementById('descInput');
      const locationInput = document.getElementById('locationInput');
      const typeInput = document.getElementById('typeInput');
      const workModeInput = document.getElementById('workModeInput');
      const salaryInput = document.getElementById('salaryInput');
      const requirementsInput = document.getElementById('requirementsInput');
      const applicationDeadlineInput = document.getElementById('applicationDeadlineInput');
      const expiresAtInput = document.getElementById('expiresAtInput');

      const formMsg = document.getElementById('formMsg');

      // -------------------------
      // Auth helpers (consistent across app)
      // -------------------------
      function readUniTalentAuth() {
        const token =
          localStorage.getItem('unitalent_token') ||
          sessionStorage.getItem('unitalent_token');

        const userRaw =
          localStorage.getItem('unitalent_user') ||
          sessionStorage.getItem('unitalent_user');

        if (!token || !userRaw) return { token: null, user: null };

        try {
          const user = JSON.parse(userRaw);
          return { token, user };
        } catch {
          localStorage.removeItem('unitalent_token');
          localStorage.removeItem('unitalent_user');
          sessionStorage.removeItem('unitalent_token');
          sessionStorage.removeItem('unitalent_user');
          return { token: null, user: null };
        }
      }

      function requireEmployerPage() {
        const { token, user } = readUniTalentAuth();

        if (!token || !user) {
          setAuthStatus(false, 'Not logged in. Please log in as employer.');
          window.location.href = 'employer-login.html';
          return null;
        }

        if (user.role !== 'EMPLOYER') {
          setAuthStatus(false, 'Forbidden: this page is for EMPLOYER accounts only.');
          window.location.href =
            user.role === 'STUDENT' ? 'student-login.html' : 'employer-login.html';
          return null;
        }

        return { token, user };
      }

      // -------------------------
      // UI helpers
      // -------------------------
      function setAuthStatus(ok, text) {
        if (!authStatus) return;
        authStatus.innerHTML = `
        <span class="inline-flex h-2 w-2 rounded-full ${ok ? 'bg-emerald-400' : 'bg-rose-400'}"></span>
        <span>${text}</span>
      `;
      }

      function showFormMsg(type, text) {
        if (!formMsg) return;

        formMsg.classList.remove('hidden');
        formMsg.className =
          'rounded-2xl border px-3 py-2 text-xs ' +
          (type === 'ok'
            ? 'border-emerald-500/40 bg-emerald-500/10 text-emerald-200'
            : 'border-rose-500/40 bg-rose-500/10 text-rose-200');

        formMsg.textContent = text;
      }

      function hideFormMsg() {
        if (!formMsg) return;
        formMsg.classList.add('hidden');
        formMsg.textContent = '';
      }

      function disableForm(disabled) {
        if (submitBtn) submitBtn.disabled = disabled;
        [titleInput, descInput, locationInput, typeInput, workModeInput, salaryInput, requirementsInput].forEach(el => {
          if (el) el.disabled = disabled;
        });
      }

      // -------------------------
      // ✅ HARD ROLE GUARD
      // -------------------------
      const auth = requireEmployerPage();
      if (!auth) return;

      setAuthStatus(true, 'Employer authenticated. Ready to publish.');

      // -------------------------
      // Logout
      // -------------------------
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          localStorage.removeItem('unitalent_token');
          localStorage.removeItem('unitalent_user');
          sessionStorage.removeItem('unitalent_token');
          sessionStorage.removeItem('unitalent_user');

          // optional employer UI keys
          localStorage.removeItem('unitalent_employer_name');
          localStorage.removeItem('unitalent_employer_bin');
          localStorage.removeItem('unitalent_employer_city');
          localStorage.removeItem('unitalent_employer_size');

          window.location.href = 'employer-login.html';
        });
      }

      // -------------------------
      // Submit job
      // -------------------------
      if (jobForm) {
        jobForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          hideFormMsg();

          // re-check auth at submit time (safer)
          const { token, user } = readUniTalentAuth();
          if (!token || !user || user.role !== 'EMPLOYER') {
            showFormMsg('err', 'Session expired. Please log in again as employer.');
            setAuthStatus(false, 'Session expired.');
            window.location.href = 'employer-login.html';
            return;
          }

          const title = (titleInput?.value || '').trim();
          const description = (descInput?.value || '').trim();
          const location = (locationInput?.value || '').trim();
          const type = (typeInput?.value || '').trim();
          const workMode = (workModeInput?.value || '').trim();
          const salary = (salaryInput?.value || '').trim();
          const requirements = (requirementsInput?.value || '').trim();
          const applicationDeadline = applicationDeadlineInput?.value || null;
          const expiresAt = expiresAtInput?.value || null;

          if (!title || !description) {
            showFormMsg('err', 'Title and description are required.');
            return;
          }

          const payload = {
            title,
            description,
            location: location || undefined,
            type: type || undefined,
            workMode: workMode || undefined,
            salary: salary || undefined,
            requirements: requirements || undefined,
            applicationDeadline: applicationDeadline || undefined,
            expiresAt: expiresAt || undefined
          };

          const oldBtnText = submitBtn?.textContent || 'Publish job';

          try {
            disableForm(true);
            if (submitBtn) submitBtn.textContent = 'Publishing...';

            const res = await fetch(`${API}/api/jobs`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
              },
              body: JSON.stringify(payload)
            });

            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
              const msg =
                data?.message ||
                (res.status === 401 ? 'Invalid/expired token. Please log in again.' :
                  res.status === 403 ? 'Forbidden. Your account is not EMPLOYER.' :
                    'Failed to publish job.');

              showFormMsg('err', msg);
              setAuthStatus(false, msg);
              return;
            }

            showFormMsg('ok', 'Job published successfully ✅ It is now visible in jobs list.');
            setAuthStatus(true, 'Job published.');

            // Reset form
            if (titleInput) titleInput.value = '';
            if (descInput) descInput.value = '';
            if (locationInput) locationInput.value = '';
            if (typeInput) typeInput.value = '';
            if (workModeInput) workModeInput.value = '';
            if (salaryInput) salaryInput.value = '';
            if (requirementsInput) requirementsInput.value = '';
            if (applicationDeadlineInput) applicationDeadlineInput.value = '';
            if (expiresAtInput) expiresAtInput.value = '';

          } catch (err) {
            console.error(err);
            showFormMsg('err', 'Network/server error. Check backend is running on port 3000.');
            setAuthStatus(false, 'Server not reachable.');
          } finally {
            disableForm(false);
            if (submitBtn) submitBtn.textContent = oldBtnText;
          }
        });
      }
    });
  </script>

  <script type="module" src="js/auth.js"></script>

</body>

</html>