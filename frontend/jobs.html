<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>UniTalent – Browse Jobs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body class="font-sans bg-slate-950 text-slate-100">
  <!-- Background blobs -->
  <div class="pointer-events-none fixed inset-0 -z-10">
    <div class="absolute -top-40 -left-32 h-72 w-72 rounded-full bg-indigo-500/40 blur-3xl"></div>
    <div class="absolute top-40 -right-20 h-80 w-80 rounded-full bg-emerald-500/30 blur-3xl"></div>
  </div>

  <!-- NAVBAR -->
  <header class="sticky top-0 z-20 border-b border-slate-800/60 bg-slate-950/80 backdrop-blur">
    <nav class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3 md:py-4">
      <a href="index.html" class="flex items-center gap-2">
        <div
          class="flex h-10 w-10 items-center justify-center rounded-2xl bg-slate-900/60 shadow-lg shadow-indigo-500/40">
          <img src="assets/logo.png" alt="UniTalent logo" class="h-8 w-8 object-contain" />
        </div>
        <div class="leading-tight">
          <p class="text-base font-semibold tracking-tight">UniTalent</p>
          <p class="text-[11px] text-slate-400">Student Career Platform</p>
        </div>
      </a>

      <div class="hidden items-center gap-6 text-sm font-medium text-slate-200 md:flex">
        <a href="index.html#how" class="hover:text-indigo-300">How it works</a>
        <a href="jobs.html" class="text-indigo-300">Jobs</a>
        <a href="student-login.html" class="hover:text-indigo-300">For students</a>
        <a href="employer-login.html" class="hover:text-indigo-300">For employers</a>
        <a href="index.html#about" class="hover:text-indigo-300">About</a>
      </div>

      <div id="authArea" class="hidden items-center gap-3 md:flex">
        <!-- Guest -->
        <a id="loginBtn" href="student-login.html" class="text-sm font-medium text-slate-200 hover:text-indigo-300">
          Log in
        </a>
        <a id="signupBtn" href="student-signup.html"
          class="rounded-full bg-indigo-500 px-4 py-2 text-sm font-semibold text-white shadow-md shadow-indigo-500/40 hover:bg-indigo-400">
          Sign up
        </a>

        <!-- Authed -->
        <a id="dashboardBtn" href="#"
          class="hidden rounded-full bg-slate-950/70 px-4 py-2 text-sm font-semibold text-slate-50 ring-1 ring-slate-700 hover:bg-slate-900 hover:ring-indigo-400">
          Dashboard
        </a>
        <button id="logoutBtn"
          class="hidden rounded-full border border-slate-700 bg-slate-950/60 px-4 py-2 text-sm font-semibold text-slate-200 hover:border-rose-400 hover:text-rose-200">
          Log out
        </button>
      </div>

      <button
        class="inline-flex items-center justify-center rounded-full border border-slate-700 p-2 text-slate-200 md:hidden">
        <span class="sr-only">Open menu</span>
        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </nav>
  </header>

  <main class="mx-auto max-w-6xl px-4 pb-16 pt-8 md:pt-10">
    <!-- Breadcrumb -->
    <div class="mb-4 text-xs text-slate-400">
      <a href="index.html" class="hover:text-indigo-300">Home</a>
      <span class="mx-1 text-slate-500">/</span>
      <span class="text-slate-300">Jobs</span>
    </div>

    <!-- Page header -->
    <section class="space-y-4">
      <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 class="text-2xl font-bold tracking-tight text-slate-50 sm:text-3xl">
            Browse opportunities
          </h1>
          <p class="mt-1 text-sm text-slate-400">
            Internships and entry-level roles from companies looking for students and fresh graduates.
          </p>
        </div>

        <div id="jobsStatus" class="flex items-center gap-2 text-xs text-slate-400">
          <span class="inline-flex h-2 w-2 rounded-full bg-slate-500"></span>
          <span>Loading jobs from backend...</span>
        </div>
      </div>

      <!-- Search -->
      <div class="mt-3 rounded-3xl border border-slate-800 bg-slate-900/80 p-4 shadow-xl shadow-slate-900/70">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div class="flex-1">
            <label class="mb-1 block text-xs font-medium text-slate-300">Search jobs</label>
            <div class="flex items-center gap-2 rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2">
              <svg class="h-4 w-4 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M21 21l-4.35-4.35M11 18a7 7 0 100-14 7 7 0 000 14z" />
              </svg>
              <input id="searchInput" type="text" placeholder="e.g. frontend, marketing, data analyst"
                class="w-full bg-transparent text-xs text-slate-100 placeholder:text-slate-500 focus:outline-none" />
            </div>
          </div>
          <div class="flex justify-end">
            <button id="searchBtn"
              class="mt-1 w-full rounded-full bg-indigo-500 px-4 py-2 text-xs font-semibold text-white shadow-md shadow-indigo-500/40 hover:bg-indigo-400 md:mt-6 md:w-auto">
              Search
            </button>
          </div>
        </div>

        <!-- Backend-supported filters -->
        <div class="mt-4 grid gap-3 text-xs md:grid-cols-3">
          <div>
            <label class="mb-1 block text-slate-300">Location</label>
            <input id="filterLocation" type="text" placeholder="e.g. Almaty, Remote"
              class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:outline-none" />
          </div>
          <div>
            <label class="mb-1 block text-slate-300">Type</label>
            <select id="filterType"
              class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
              <option value="">Any type</option>
              <option value="INTERNSHIP">Internship</option>
              <option value="PART_TIME">Part-time</option>
              <option value="FULL_TIME">Full-time</option>
            </select>
          </div>
          <div>
            <label class="mb-1 block text-slate-300">Work mode</label>
            <select id="filterWorkMode"
              class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
              <option value="">Any</option>
              <option value="ON_SITE">On-site</option>
              <option value="HYBRID">Hybrid</option>
              <option value="REMOTE">Remote</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- Jobs list -->
    <section class="mt-8 grid gap-6 md:grid-cols-[minmax(0,1.7fr),minmax(0,1fr)]">
      <div class="space-y-4">
        <div class="flex flex-col gap-2 text-xs text-slate-400 md:flex-row md:items-center md:justify-between">
          <p>
            Showing <span id="jobsCount" class="font-semibold text-slate-200">0</span> roles
          </p>
          <div class="flex items-center gap-2">
            <span>Sort by:</span>
            <button class="rounded-full bg-slate-900/80 px-3 py-1 text-[11px] text-slate-200 ring-1 ring-slate-700">
              Newest
            </button>
          </div>
        </div>

        <div id="jobsList" class="space-y-4"></div>

        <div class="mt-4 flex items-center justify-between text-xs text-slate-400">
          <p id="pageIndicator">Page 1 of 1</p>
          <div class="flex items-center gap-2">
            <button id="prevBtn"
              class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 hover:border-indigo-400 hover:text-indigo-200 disabled:cursor-not-allowed disabled:opacity-50 disabled:hover:border-slate-700 disabled:hover:text-slate-400">
              ‹ Previous
            </button>
            <button id="nextBtn"
              class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 hover:border-indigo-400 hover:text-indigo-200 disabled:cursor-not-allowed disabled:opacity-50 disabled:hover:border-slate-700 disabled:hover:text-slate-400">
              Next ›
            </button>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <aside class="space-y-4">
        <div class="rounded-3xl border border-slate-800 bg-slate-900/80 p-4 shadow-lg shadow-slate-900/70">
          <h3 class="text-sm font-semibold text-slate-50">Tips for students</h3>
          <p class="mt-2 text-xs text-slate-300">
            Apply to roles that match your skills and year of study. Even if you’re not sure you’re “ready”,
            internships are designed for learning.
          </p>
          <ul class="mt-3 space-y-1.5 text-xs text-slate-300">
            <li>• Highlight your projects and course work.</li>
            <li>• Tailor your CV for each role.</li>
            <li>• Don’t be afraid of “junior” roles – they’re for you.</li>
          </ul>
          <a href="student-login.html"
            class="mt-4 inline-flex items-center justify-center rounded-full bg-indigo-500 px-4 py-2 text-[11px] font-semibold text-white hover:bg-indigo-400">
            Create student profile
          </a>
        </div>

        <div class="overflow-hidden rounded-3xl border border-slate-800 bg-slate-900/80 shadow-lg shadow-slate-900/70">
          <img src="https://images.pexels.com/photos/1181396/pexels-photo-1181396.jpeg?auto=compress&cs=tinysrgb&w=1200"
            alt="Team working together" class="h-32 w-full object-cover" />
          <div class="p-4 text-xs">
            <p class="text-[11px] font-semibold uppercase tracking-wide text-emerald-400">
              For employers
            </p>
            <p class="mt-1 text-slate-200">Want to hire students?</p>
            <p class="mt-1 text-slate-400">
              Post your internship or junior role on UniTalent and reach motivated students from local universities.
            </p>

            <a href="employer-login.html"
              class="js-post-job-cta mt-3 inline-flex items-center justify-center rounded-full bg-slate-950/70 px-4 py-2 text-[11px] font-semibold text-slate-50 ring-1 ring-slate-700 hover:bg-slate-900">
              Post a job
            </a>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="border-t border-slate-800 bg-slate-950/90">
    <div
      class="mx-auto flex max-w-6xl flex-col gap-3 px-4 py-5 text-xs text-slate-500 md:flex-row md:items-center md:justify-between">
      <p>© 2025 UniTalent. All rights reserved.</p>
      <div class="flex flex-wrap gap-4">
        <a href="index.html#about" class="hover:text-indigo-300">About</a>
        <a href="index.html#contact" class="hover:text-indigo-300">Contact</a>
        <span>Terms · Privacy</span>
      </div>
    </div>
  </footer>

  <!-- ✅ JS (UPDATED like index.html + fixed Save API) -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const API = 'http://localhost:3000';

    // -------------------------
    // ✅ Pair-safe auth (no mixing local/session)
    // -------------------------
    function readAuthPair(storage) {
      const token = storage.getItem('unitalent_token');
      const userRaw = storage.getItem('unitalent_user');
      if (!token || !userRaw) return null;

      try {
        return { token, user: JSON.parse(userRaw), storage };
      } catch {
        storage.removeItem('unitalent_token');
        storage.removeItem('unitalent_user');
        return null;
      }
    }

    function readUniTalentAuth() {
      return (
        readAuthPair(localStorage) ||
        readAuthPair(sessionStorage) ||
        { token: null, user: null, storage: null }
      );
    }

    function clearAllAuth() {
      ['unitalent_token', 'unitalent_user'].forEach(k => {
        localStorage.removeItem(k);
        sessionStorage.removeItem(k);
      });

      [
        'unitalent_student_name',
        'unitalent_student_email',
        'unitalent_student_username',
        'unitalent_employer_name',
        'unitalent_employer_bin',
        'unitalent_employer_city',
        'unitalent_employer_size'
      ].forEach(k => {
        localStorage.removeItem(k);
        sessionStorage.removeItem(k);
      });
    }

    // -------------------------
    // Navbar auth UI
    // -------------------------
    const authArea = document.getElementById("authArea");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const dashboardBtn = document.getElementById("dashboardBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    authArea?.classList.remove("hidden");

    function setGuestUI() {
      loginBtn?.classList.remove("hidden");
      signupBtn?.classList.remove("hidden");
      dashboardBtn?.classList.add("hidden");
      logoutBtn?.classList.add("hidden");
    }

    function setAuthedUI(user) {
      loginBtn?.classList.add("hidden");
      signupBtn?.classList.add("hidden");
      dashboardBtn?.classList.remove("hidden");
      logoutBtn?.classList.remove("hidden");

      dashboardBtn.href =
        user?.role === "EMPLOYER"
          ? "employer-dashboard.html"
          : "student-dashboard.html";
    }

    const { token, user } = readUniTalentAuth();
    if (token && user) setAuthedUI(user);
    else setGuestUI();

    logoutBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      clearAllAuth();
      window.location.href = "index.html";
    });

    // -------------------------
    // ✅ Employer "Post a job" CTA fix
    // -------------------------
    function handlePostJobClick(e) {
      const { token: t, user: u } = readUniTalentAuth();

      if (!t || !u) {
        // Not logged in -> default link to employer-login.html
        return;
      }

      if (u.role === 'EMPLOYER') {
        e.preventDefault();
        window.location.href = 'employer-new-job.html';
        return;
      }

      if (u.role === 'STUDENT') {
        e.preventDefault();
        alert('You are logged in as STUDENT. Please log in with an EMPLOYER account to post jobs.');
      }
    }

    document.querySelectorAll('.js-post-job-cta').forEach(btn => {
      btn.addEventListener('click', handlePostJobClick);
    });

    // -------------------------
    // Jobs elements
    // -------------------------
    const jobsList = document.getElementById('jobsList');
    const jobsCount = document.getElementById('jobsCount');
    const jobsStatus = document.getElementById('jobsStatus');

    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const filterLocation = document.getElementById('filterLocation');
    const filterType = document.getElementById('filterType');
    const filterWorkMode = document.getElementById('filterWorkMode');

    let allJobs = [];
    let lastRendered = [];
    let savedJobIds = new Set();
    let currentPage = 1;
    const jobsPerPage = 6;

    function setStatus(ok, text) {
      if (!jobsStatus) return;
      jobsStatus.innerHTML = `
        <span class="inline-flex h-2 w-2 rounded-full ${ok ? 'bg-emerald-400' : 'bg-rose-400'}"></span>
        <span>${text}</span>
      `;
    }

    function escapeHtml(str = '') {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function truncate(text = '', n = 180) {
      const t = String(text);
      return t.length > n ? t.slice(0, n).trim() + '…' : t;
    }

    function employerDisplay(job) {
      const fn = job.employer?.firstName;
      const ln = job.employer?.lastName;
      const full = [fn, ln].filter(Boolean).join(' ');
      return full || job.employer?.email || 'Company';
    }

    // ✅ Load saved jobs ids for student
    async function loadSavedJobIds() {
      const { token: t, user: u } = readUniTalentAuth();
      if (!t || !u || u.role !== "STUDENT") return new Set();

      try {
        const res = await fetch(`${API}/api/saved-jobs/my`, {
          headers: { Authorization: "Bearer " + t }
        });

        if (res.status === 401) {
          clearAllAuth();
          return new Set();
        }

        const data = await res.json().catch(() => []);
        const ids = new Set(
          Array.isArray(data)
            ? data.map(x => Number(x.jobId)).filter(Boolean)
            : []
        );

        return ids;
      } catch (e) {
        console.error(e);
        return new Set();
      }
    }

    function render(jobs) {
      // Pagination: calculate total pages and slice jobs for current page
      const totalPages = Math.max(1, Math.ceil(jobs.length / jobsPerPage));
      const startIndex = (currentPage - 1) * jobsPerPage;
      const endIndex = startIndex + jobsPerPage;
      const paginatedJobs = jobs.slice(startIndex, endIndex);
      
      lastRendered = paginatedJobs;

      // Update jobs count (show total, not paginated count)
      if (jobsCount) jobsCount.textContent = jobs.length;
      
      // Update page indicator
      const pageIndicator = document.getElementById('pageIndicator');
      if (pageIndicator) {
        pageIndicator.textContent = `Page ${currentPage} of ${totalPages}`;
      }
      
      // Update pagination buttons
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      if (prevBtn) {
        prevBtn.disabled = currentPage === 1;
      }
      if (nextBtn) {
        nextBtn.disabled = currentPage >= totalPages;
      }

      if (!jobsList) return;

      if (!paginatedJobs.length) {
        jobsList.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-6 text-sm text-slate-300">
            ${jobs.length === 0 
              ? 'No jobs found yet. Employers will appear here after posting.'
              : 'No jobs on this page.'}
          </div>
        `;
        return;
      }

      jobsList.innerHTML = paginatedJobs.map(job => {
        const title = escapeHtml(job.title || 'Untitled role');
        const desc = escapeHtml(truncate(job.description || ''));
        const location = escapeHtml(job.location || 'Location not specified');
        const salary = escapeHtml(job.salary || 'Salary not specified');
        const employerName = escapeHtml(employerDisplay(job));

        const isSaved = savedJobIds.has(Number(job.id));
        const saveText = isSaved ? "❤️ Saved" : "♡ Save";
        const saveCls = isSaved ? "saved border-rose-400/60 text-rose-200" : "";

        return `
          <article class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 shadow-lg shadow-slate-900/60">
            <div class="flex flex-col gap-3 md:flex-row md:justify-between">
              <div class="space-y-1">
                <p class="text-[11px] uppercase tracking-wide text-emerald-400">
                  Internal job · UniTalent
                </p>
                <h2 class="text-sm font-semibold text-slate-50">${title}</h2>
                <p class="text-xs text-slate-400">
                  ${employerName} · ${location}
                </p>
                <p class="mt-2 text-xs text-slate-300">${desc}</p>
              </div>

              <div class="flex flex-col items-end justify-between gap-2 text-xs">
                <div class="text-right">
                  <p class="font-semibold text-slate-100">${salary}</p>
                  <p class="text-[11px] text-slate-400">Posted recently</p>
                </div>

                <div class="flex gap-2">
                  <a href="student-login.html"
                    class="js-apply-btn rounded-full bg-indigo-500 px-3 py-1.5 text-[11px] font-semibold text-white hover:bg-indigo-400"
                    data-job-id="${job.id}">
                    Apply now
                  </a>

                  <button
                    class="js-save-btn ${saveCls} rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1.5 text-[11px] text-slate-200 hover:border-indigo-400 hover:text-indigo-200"
                    data-job-id="${job.id}">
                    ${saveText}
                  </button>
                </div>
              </div>
            </div>
          </article>
        `;
      }).join('');
    }

    async function loadJobs() {
      try {
        setStatus(true, 'Loading jobs from backend...');

        // Build query params from filters
        const params = new URLSearchParams();
        const q = (searchInput?.value || '').trim();
        const location = (filterLocation?.value || '').trim();
        const type = (filterType?.value || '').trim();
        const workMode = (filterWorkMode?.value || '').trim();

        if (q) params.append('q', q);
        if (location) params.append('location', location);
        if (type) params.append('type', type);
        if (workMode) params.append('workMode', workMode);

        const queryString = params.toString();
        const url = `${API}/api/jobs${queryString ? '?' + queryString : ''}`;

        const res = await fetch(url);
        const data = await res.json().catch(() => ([]));

        if (!res.ok) throw new Error(data?.message || 'Failed to load jobs');

        allJobs = Array.isArray(data) ? data : [];
        // Reset to page 1 when loading new jobs
        currentPage = 1;
        render(allJobs);

        // ✅ After jobs load, load saved ids & re-render current view
        savedJobIds = await loadSavedJobIds();
        render(allJobs);

        const filterText = queryString ? ' (filtered)' : '';
        setStatus(true, `Loaded ${allJobs.length} jobs from UniTalent backend${filterText}`);
      } catch (err) {
        console.error(err);
        setStatus(false, 'Backend jobs not available. Check server.');
        render([]);
      }
    }

    function applySearch() {
      loadJobs();
    }

    // ✅ Apply handler (event delegation)
    if (jobsList) {
      jobsList.addEventListener('click', async (e) => {
        const btn = e.target.closest('.js-apply-btn');
        if (!btn) return;

        const { token: t, user: u } = readUniTalentAuth();

        if (!t) {
          // not logged in -> allow default href to login
          return;
        }

        if (u?.role && u.role !== 'STUDENT') {
          e.preventDefault();
          setStatus(false, 'Only STUDENT accounts can apply.');
          return;
        }

        e.preventDefault();

        const jobId = Number(btn.dataset.jobId);
        if (!jobId) return;

        const originalText = btn.textContent;

        try {
          btn.textContent = 'Applying...';
          btn.classList.add('opacity-70', 'pointer-events-none');

          const res = await fetch(`${API}/api/applications`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + t
            },
            body: JSON.stringify({ jobId })
          });

          if (res.status === 401) {
            clearAllAuth();
            window.location.href = 'student-login.html';
            return;
          }

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            const msg =
              data?.message ||
              (res.status === 403 ? 'Forbidden.' : 'Failed to apply.');
            throw new Error(msg);
          }

          btn.textContent = 'Applied';
          btn.classList.remove('bg-indigo-500', 'hover:bg-indigo-400');
          btn.classList.add('bg-emerald-500');
          setStatus(true, 'Application sent successfully ✅');
        } catch (err) {
          console.error(err);
          btn.textContent = originalText || 'Apply now';
          btn.classList.remove('opacity-70', 'pointer-events-none');
          setStatus(false, err.message);
        }
      });
    }

    // ✅ Save / Unsave handler (event delegation)
    if (jobsList) {
      jobsList.addEventListener("click", async (e) => {
        const btn = e.target.closest(".js-save-btn");
        if (!btn) return;

        const { token: t, user: u } = readUniTalentAuth();

        if (!t || !u) {
          window.location.href = "student-login.html";
          return;
        }

        if (u.role !== "STUDENT") {
          setStatus(false, "Only STUDENT accounts can save jobs.");
          return;
        }

        const jobId = Number(btn.dataset.jobId);
        if (!jobId) return;

        const isSaved = savedJobIds.has(jobId);

        const originalText = btn.textContent;
        btn.disabled = true;
        btn.classList.add("opacity-60");

        try {
          let res;

          // ✅ IMPORTANT FIX:
          // POST  -> /api/saved-jobs  body { jobId }
          // DELETE-> /api/saved-jobs/:jobId  (NO body needed)
          if (isSaved) {
            res = await fetch(`${API}/api/saved-jobs/${jobId}`, {
              method: "DELETE",
              headers: {
                Authorization: "Bearer " + t
              }
            });
          } else {
            res = await fetch(`${API}/api/saved-jobs`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + t
              },
              body: JSON.stringify({ jobId })
            });
          }

          if (res.status === 401) {
            clearAllAuth();
            window.location.href = "student-login.html";
            return;
          }

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            // If backend says already saved, sync UI
            if (res.status === 409) {
              savedJobIds.add(jobId);
              btn.textContent = "❤️ Saved";
              btn.classList.add("saved", "border-rose-400/60", "text-rose-200");
              setStatus(true, "Already saved ✅");
              return;
            }
            throw new Error(data?.message || "Failed to update saved jobs");
          }

          if (isSaved) {
            savedJobIds.delete(jobId);
            btn.textContent = "♡ Save";
            btn.classList.remove("saved", "border-rose-400/60", "text-rose-200");
            setStatus(true, "Removed from saved ✅");
          } else {
            savedJobIds.add(jobId);
            btn.textContent = "❤️ Saved";
            btn.classList.add("saved", "border-rose-400/60", "text-rose-200");
            setStatus(true, "Job saved ✅");
          }
        } catch (err) {
          console.error(err);
          btn.textContent = originalText;
          setStatus(false, err.message || "Failed to save job");
        } finally {
          btn.disabled = false;
          btn.classList.remove("opacity-60");
        }
      });
    }

    if (searchBtn) searchBtn.addEventListener('click', applySearch);
    if (searchInput) {
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          applySearch();
        }
      });
    }

    // Auto-apply filters when they change
    [filterLocation, filterType, filterWorkMode].forEach(el => {
      if (el) {
        el.addEventListener('change', applySearch);
        if (el.tagName === 'INPUT') {
          el.addEventListener('input', (e) => {
            // Debounce input search
            clearTimeout(el._debounce);
            el._debounce = setTimeout(applySearch, 500);
          });
        }
      }
    });

    // Pagination handlers
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          render(allJobs);
          // Scroll to top of jobs list
          jobsList?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
    
    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        const totalPages = Math.max(1, Math.ceil(allJobs.length / jobsPerPage));
        if (currentPage < totalPages) {
          currentPage++;
          render(allJobs);
          // Scroll to top of jobs list
          jobsList?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }

    loadJobs();
  });
</script>


  <!-- If you already have shared auth logic here, you can keep it.
       If this causes double-handling later, we can remove it. -->
  <script type="module" src="js/auth.js"></script>

</body>

</html>
