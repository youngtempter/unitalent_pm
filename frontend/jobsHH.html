<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>UniTalent – HH Vacancies</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>

  <body class="font-sans bg-slate-950 text-slate-100">
    <!-- Background blobs -->
    <div class="pointer-events-none fixed inset-0 -z-10">
      <div
        class="absolute -top-40 -left-32 h-72 w-72 rounded-full bg-indigo-500/40 blur-3xl"
      ></div>
      <div
        class="absolute top-40 -right-20 h-80 w-80 rounded-full bg-emerald-500/30 blur-3xl"
      ></div>
    </div>

    <!-- NAVBAR -->
    <header
      class="sticky top-0 z-20 border-b border-slate-800/60 bg-slate-950/80 backdrop-blur"
    >
      <nav
        class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3 md:py-4"
      >
        <a href="index.html" class="flex items-center gap-2">
          <div
            class="flex h-10 w-10 items-center justify-center rounded-2xl bg-slate-900/60 shadow-lg shadow-indigo-500/40"
          >
            <img
              src="assets/logo.png"
              alt="UniTalent logo"
              class="h-8 w-8 object-contain"
            />
          </div>
          <div class="leading-tight">
            <p class="text-base font-semibold tracking-tight">UniTalent</p>
            <p class="text-[11px] text-slate-400">Student Career Platform</p>
          </div>
        </a>

        <div
          class="hidden items-center gap-6 text-sm font-medium text-slate-200 md:flex"
        >
          <a href="index.html#how" class="hover:text-indigo-300"
            >How it works</a
          >
          <a href="jobs.html" class="text-indigo-300">Jobs</a>
          <a href="student-login.html" class="hover:text-indigo-300"
            >For students</a
          >
          <a href="employer-login.html" class="hover:text-indigo-300"
            >For employers</a
          >
          <a href="index.html#about" class="hover:text-indigo-300">About</a>
        </div>

        <div id="authArea" class="hidden items-center gap-3 md:flex">
          <!-- Guest -->
          <a
            id="loginBtn"
            href="student-login.html"
            class="text-sm font-medium text-slate-200 hover:text-indigo-300"
          >
            Log in
          </a>
          <a
            id="signupBtn"
            href="student-signup.html"
            class="rounded-full bg-indigo-500 px-4 py-2 text-sm font-semibold text-white shadow-md shadow-indigo-500/40 hover:bg-indigo-400"
          >
            Sign up
          </a>

          <!-- Authed -->
          <a
            id="dashboardBtn"
            href="#"
            class="hidden rounded-full bg-slate-950/70 px-4 py-2 text-sm font-semibold text-slate-50 ring-1 ring-slate-700 hover:bg-slate-900 hover:ring-indigo-400"
          >
            Dashboard
          </a>
          <button
            id="logoutBtn"
            class="hidden rounded-full border border-slate-700 bg-slate-950/60 px-4 py-2 text-sm font-semibold text-slate-200 hover:border-rose-400 hover:text-rose-200"
          >
            Log out
          </button>
        </div>

        <button
          class="inline-flex items-center justify-center rounded-full border border-slate-700 p-2 text-slate-200 md:hidden"
        >
          <span class="sr-only">Open menu</span>
          <svg
            class="h-5 w-5"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M4 6h16M4 12h16M4 18h16"
            />
          </svg>
        </button>
      </nav>
    </header>

    <main class="mx-auto max-w-6xl px-4 pb-16 pt-8 md:pt-10">
      <!-- Breadcrumb -->
      <div class="mb-4 text-xs text-slate-400">
        <a href="index.html" class="hover:text-indigo-300">Home</a>
        <span class="mx-1 text-slate-500">/</span>
        <a href="jobs.html" class="hover:text-indigo-300">Jobs</a>
        <span class="mx-1 text-slate-500">/</span>
        <span class="text-slate-300">HH jobs</span>
      </div>

      <!-- Page header -->
      <section class="space-y-4">
        <div
          class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between"
        >
          <div>
            <p class="text-[11px] uppercase tracking-wide text-emerald-400">
              HeadHunter feed
            </p>
            <h1
              class="text-2xl font-bold tracking-tight text-slate-50 sm:text-3xl"
            >
              Vacancies parsed from hh.kz / hh.ru
            </h1>
            <p class="mt-1 text-sm text-slate-400">
              We fetch and dedupe HH vacancies via the Python scraper, and link
              you straight to the original posting.
            </p>
          </div>

          <div
            id="jobsStatus"
            class="flex items-center gap-2 text-xs text-slate-400"
          >
            <span class="inline-flex h-2 w-2 rounded-full bg-slate-500"></span>
            <span>Waiting to load HH data…</span>
          </div>
        </div>

        <!-- Search -->
        <div
          class="mt-3 rounded-3xl border border-slate-800 bg-slate-900/80 p-4 shadow-xl shadow-slate-900/70"
        >
          <div class="grid gap-3 text-xs md:grid-cols-4 md:items-end">
            <div class="md:col-span-2">
              <label class="mb-1 block text-slate-300"
                >Search by title or requirements</label
              >
              <div
                class="flex items-center gap-2 rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2"
              >
                <svg
                  class="h-4 w-4 text-slate-500"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.5"
                    d="M21 21l-4.35-4.35M11 18a7 7 0 100-14 7 7 0 000 14z"
                  />
                </svg>
                <input
                  id="searchInput"
                  type="text"
                  placeholder="e.g. python, frontend, data"
                  class="w-full bg-transparent text-xs text-slate-100 placeholder:text-slate-500 focus:outline-none"
                />
              </div>
            </div>

            <div>
              <label class="mb-1 block text-slate-300">City</label>
              <input
                id="cityInput"
                type="text"
                placeholder="e.g. Almaty, Remote"
                class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-xs text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:outline-none"
              />
            </div>

            <div>
              <label class="mb-1 block text-slate-300">Per page</label>
              <select
                id="limitSelect"
                class="w-full rounded-2xl border border-slate-700 bg-slate-950/70 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none"
              >
                <option value="20" selected>20</option>
                <option value="40">40</option>
                <option value="60">60</option>
              </select>
            </div>
          </div>

          <div
            class="mt-3 flex flex-col gap-2 text-[11px] text-slate-400 md:flex-row md:items-center md:justify-between"
          >
            <p>
              Data comes directly from the SQLite filled by the Python scraper
              (`vacancies.db`).
            </p>
            <button
              id="searchBtn"
              class="w-full rounded-full bg-indigo-500 px-4 py-2 text-xs font-semibold text-white shadow-md shadow-indigo-500/40 hover:bg-indigo-400 md:w-auto"
            >
              Refresh HH jobs
            </button>
          </div>
        </div>
      </section>

      <!-- Jobs list -->
      <section class="mt-8">
        <div
          class="flex flex-col gap-2 text-xs text-slate-400 md:flex-row md:items-center md:justify-between"
        >
          <p>
            Showing
            <span id="jobsCount" class="font-semibold text-slate-200">0</span>
            HH vacancies
          </p>
          <div
            class="inline-flex items-center gap-2 rounded-full bg-slate-900/70 px-3 py-1 text-[11px] text-slate-200 ring-1 ring-slate-800"
          >
            <span class="h-2 w-2 rounded-full bg-indigo-400"></span>
            Source: HeadHunter (links open in new tab)
          </div>
        </div>

        <div id="jobsList" class="mt-4 grid gap-4 md:grid-cols-2"></div>

        <div
          class="mt-5 flex items-center justify-between text-xs text-slate-400"
        >
          <p id="pageIndicator">Page 1 of 1</p>
          <div class="flex items-center gap-2">
            <button
              id="prevBtn"
              class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 hover:border-indigo-400 hover:text-indigo-200 disabled:cursor-not-allowed disabled:opacity-50 disabled:hover:border-slate-700 disabled:hover:text-slate-400"
            >
              ‹ Previous
            </button>
            <button
              id="nextBtn"
              class="rounded-full border border-slate-700 bg-slate-950/60 px-3 py-1 hover:border-indigo-400 hover:text-indigo-200 disabled:cursor-not-allowed disabled:opacity-50 disabled:hover:border-slate-700 disabled:hover:text-slate-400"
            >
              Next ›
            </button>
          </div>
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="border-t border-slate-800 bg-slate-950/90">
      <div
        class="mx-auto flex max-w-6xl flex-col gap-3 px-4 py-5 text-xs text-slate-500 md:flex-row md:items-center md:justify-between"
      >
        <p>© 2025 UniTalent. All rights reserved.</p>
        <div class="flex flex-wrap gap-4">
          <a href="index.html#about" class="hover:text-indigo-300">About</a>
          <a href="index.html#contact" class="hover:text-indigo-300">Contact</a>
          <span>Terms · Privacy</span>
        </div>
      </div>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const API = "http://localhost:3000";

        // -------------------------
        // Auth helpers (trimmed)
        // -------------------------
        function readAuthPair(storage) {
          const token = storage.getItem("unitalent_token");
          const userRaw = storage.getItem("unitalent_user");
          if (!token || !userRaw) return null;
          try {
            return { token, user: JSON.parse(userRaw), storage };
          } catch {
            storage.removeItem("unitalent_token");
            storage.removeItem("unitalent_user");
            return null;
          }
        }

        function readUniTalentAuth() {
          return (
            readAuthPair(localStorage) ||
            readAuthPair(sessionStorage) || {
              token: null,
              user: null,
              storage: null,
            }
          );
        }

        function clearAllAuth() {
          ["unitalent_token", "unitalent_user"].forEach((k) => {
            localStorage.removeItem(k);
            sessionStorage.removeItem(k);
          });
        }

        const authArea = document.getElementById("authArea");
        const loginBtn = document.getElementById("loginBtn");
        const signupBtn = document.getElementById("signupBtn");
        const dashboardBtn = document.getElementById("dashboardBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        authArea?.classList.remove("hidden");

        function setGuestUI() {
          loginBtn?.classList.remove("hidden");
          signupBtn?.classList.remove("hidden");
          dashboardBtn?.classList.add("hidden");
          logoutBtn?.classList.add("hidden");
        }
        function setAuthedUI(user) {
          loginBtn?.classList.add("hidden");
          signupBtn?.classList.add("hidden");
          dashboardBtn?.classList.remove("hidden");
          logoutBtn?.classList.remove("hidden");
          dashboardBtn.href =
            user?.role === "EMPLOYER"
              ? "employer-dashboard.html"
              : "student-dashboard.html";
        }

        const { token, user } = readUniTalentAuth();
        if (token && user) setAuthedUI(user);
        else setGuestUI();

        logoutBtn?.addEventListener("click", (e) => {
          e.preventDefault();
          clearAllAuth();
          window.location.href = "index.html";
        });

        // -------------------------
        // HH jobs
        // -------------------------
        const jobsList = document.getElementById("jobsList");
        const jobsCount = document.getElementById("jobsCount");
        const jobsStatus = document.getElementById("jobsStatus");
        const searchInput = document.getElementById("searchInput");
        const cityInput = document.getElementById("cityInput");
        const limitSelect = document.getElementById("limitSelect");
        const searchBtn = document.getElementById("searchBtn");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const pageIndicator = document.getElementById("pageIndicator");

        let currentPage = 1;
        let totalPages = 1;
        let totalCount = 0;

        function setStatus(ok, text) {
          if (!jobsStatus) return;
          jobsStatus.innerHTML = `
          <span class="inline-flex h-2 w-2 rounded-full ${
            ok ? "bg-emerald-400" : "bg-rose-400"
          }"></span>
          <span>${text}</span>
        `;
        }

        function escapeHtml(str = "") {
          return String(str)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function truncate(text = "", n = 180) {
          const t = String(text);
          return t.length > n ? t.slice(0, n).trim() + "…" : t;
        }

        function formatDate(dateStr) {
          if (!dateStr) return "Date not provided";
          try {
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? dateStr : d.toLocaleDateString();
          } catch {
            return dateStr;
          }
        }

        function render(list) {
          if (jobsCount) jobsCount.textContent = totalCount || list.length;

          if (pageIndicator) {
            pageIndicator.textContent = `Page ${currentPage} of ${totalPages}`;
          }
          if (prevBtn) prevBtn.disabled = currentPage <= 1;
          if (nextBtn) nextBtn.disabled = currentPage >= totalPages;

          if (!list.length) {
            jobsList.innerHTML = `
            <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-6 text-sm text-slate-300">
              No HH vacancies found. Run the Python parser and refresh.
            </div>
          `;
            return;
          }

          jobsList.innerHTML = list
            .map((v) => {
              const title = escapeHtml(v.title || "Untitled role");
              const employer = escapeHtml(v.employer || "Company");
              const city = escapeHtml(v.city || "Location not specified");
              const salary = escapeHtml(v.salary || "Salary not specified");
              const req = escapeHtml(truncate(v.requirements || ""));
              const resp = escapeHtml(truncate(v.responsibilities || ""));
              const kw = escapeHtml(v.job_keyword || "");
              const date = escapeHtml(formatDate(v.publish_date));
              const url = v.url || "#";

              return `
            <article class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 shadow-lg shadow-slate-900/60">
              <div class="flex items-center gap-2 text-[11px] uppercase tracking-wide text-emerald-400">
                <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
                HeadHunter · ${kw || "Keyword"}
              </div>
              <div class="mt-2 flex flex-col gap-2">
                <h2 class="text-sm font-semibold text-slate-50">${title}</h2>
                <p class="text-xs text-slate-400">${employer} · ${city}</p>
                <p class="text-xs text-slate-300">${
                  req || resp || "No description provided"
                }</p>
              </div>
              <div class="mt-3 flex flex-wrap items-center justify-between gap-3 text-xs text-slate-300">
                <div>
                  <p class="font-semibold text-slate-100">${salary}</p>
                  <p class="text-[11px] text-slate-500">Published: ${date}</p>
                </div>
                <a href="${url}" target="_blank" rel="noopener"
                  class="inline-flex items-center justify-center rounded-full bg-indigo-500 px-3 py-1.5 text-[11px] font-semibold text-white hover:bg-indigo-400">
                  Apply on HH ↗
                </a>
              </div>
            </article>
          `;
            })
            .join("");
        }

        async function loadHH() {
          try {
            setStatus(true, "Loading HH vacancies…");

            const params = new URLSearchParams();
            const q = (searchInput?.value || "").trim();
            const city = (cityInput?.value || "").trim();
            const limit = Number(limitSelect?.value || 20);
            if (q) params.append("q", q);
            if (city) params.append("city", city);
            params.append("page", currentPage);
            params.append("limit", limit);

            const url = `${API}/api/hh-jobs${
              params.toString() ? "?" + params.toString() : ""
            }`;
            const res = await fetch(url);
            const data = await res.json().catch(() => ({}));

            if (!res.ok)
              throw new Error(data?.message || "Failed to load HH vacancies");

            const list = Array.isArray(data?.items)
              ? data.items
              : Array.isArray(data)
              ? data
              : [];
            totalCount = Number(data?.total) || list.length;
            totalPages = Number(data?.totalPages) || 1;
            currentPage = Number(data?.page) || currentPage;
            render(list);
            setStatus(
              true,
              `Loaded ${list.length} vacancies (page ${currentPage}/${totalPages})`
            );
          } catch (err) {
            console.error(err);
            render([]);
            setStatus(false, err.message || "HH vacancies not available");
          }
        }

        function triggerSearch() {
          currentPage = 1;
          loadHH();
        }

        searchBtn?.addEventListener("click", triggerSearch);
        searchInput?.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            triggerSearch();
          }
        });
        cityInput?.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            triggerSearch();
          }
        });
        limitSelect?.addEventListener("change", () => {
          currentPage = 1;
          triggerSearch();
        });

        prevBtn?.addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage -= 1;
            loadHH();
            jobsList?.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });

        nextBtn?.addEventListener("click", () => {
          if (currentPage < totalPages) {
            currentPage += 1;
            loadHH();
            jobsList?.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });

        loadHH();
      });
    </script>
  </body>
</html>
