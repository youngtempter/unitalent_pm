<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>UniTalent ‚Äì Employer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Abstract animated background -->
  <style>
    body {
      position: relative;
      overflow-x: hidden;
      background: #020617;
    }

    .animated-bg {
      position: fixed;
      inset: 0;
      z-index: -10;
      pointer-events: none;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      overflow: hidden;
    }

    .animated-bg::before {
      content: "";
      position: absolute;
      left: -50%;
      bottom: -40%;
      width: 200%;
      height: 200%;
      background-image: radial-gradient(#64748b 1px, transparent 1px);
      background-size: 26px 26px;
      opacity: 0.6;
      transform-origin: center;
      transform: perspective(900px) rotateX(72deg) translateY(0);
      animation: moveGrid 18s linear infinite;
    }

    @keyframes moveGrid {
      0% {
        transform: perspective(900px) rotateX(72deg) translateY(0);
      }

      100% {
        transform: perspective(900px) rotateX(72deg) translateY(140px);
      }
    }
  </style>
</head>

<body class="font-sans text-slate-100" data-guard="EMPLOYER">
  <!-- Background -->
  <div class="animated-bg"></div>

  <!-- NAVBAR -->
  <header class="sticky top-0 z-20 border-b border-slate-800/60 bg-slate-950/80 backdrop-blur">
    <nav class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3 md:py-4">
      <!-- Logo -->
      <a href="index.html" class="flex items-center gap-2">
        <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-slate-900/60 shadow-lg shadow-indigo-500/40">
          <img src="assets/logo.png" alt="UniTalent logo" class="h-8 w-8 object-contain" />
        </div>
        <div class="leading-tight">
          <p class="text-base font-semibold tracking-tight">UniTalent</p>
          <p class="text-[11px] text-slate-400">Student Career Platform</p>
        </div>
      </a>

      <!-- Desktop menu -->
      <div class="hidden items-center gap-6 text-sm font-medium text-slate-200 md:flex">
        <a href="index.html#how" class="hover:text-indigo-300">How it works</a>
        <a href="jobs.html" class="hover:text-indigo-300">Jobs</a>
        <a href="employer-browse-students.html" class="hover:text-indigo-300">Students</a>
        <a href="student-login.html" class="hover:text-indigo-300">For students</a>
        <a href="employer-login.html" class="text-indigo-300">For employers</a>
        <a href="index.html#about" class="hover:text-indigo-300">About</a>

        <a href="employer-interviews.html"
          class="rounded-full bg-slate-900/80 px-3 py-2 text-[11px] font-semibold text-slate-200 ring-1 ring-slate-700 hover:ring-emerald-400">
          Interviews
        </a>

      </div>

      <!-- Employer identity + Logout -->
      <div class="hidden items-center gap-3 md:flex">
        <span class="text-xs text-slate-400">Logged in as</span>

        <span id="nav-employer-pill" class="rounded-full bg-slate-900 px-3 py-1 text-xs font-semibold text-slate-100">
          Employer ¬∑ Company
        </span>

        <button id="logout-btn"
          class="rounded-full bg-slate-900/80 px-3 py-1 text-[11px] font-semibold text-slate-200 ring-1 ring-slate-700 hover:ring-rose-400">
          Logout
        </button>
      </div>

      <!-- Mobile menu button -->
      <button
        class="inline-flex items-center justify-center rounded-full border border-slate-700 p-2 text-slate-200 md:hidden">
        <span class="sr-only">Open menu</span>
        <svg class="h-5 w-5" xmlns="https://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </nav>
  </header>

  <!-- MAIN -->
  <main class="mx-auto max-w-6xl px-4 pb-16 pt-6 md:pt-8">
    <!-- Breadcrumb -->
    <div class="mb-4 text-xs text-slate-400">
      <a href="index.html" class="hover:text-indigo-300">Home</a>
      <span class="mx-1 text-slate-500">/</span>
      <a href="employer-login.html" class="hover:text-indigo-300">Employer login</a>
      <span class="mx-1 text-slate-500">/</span>
      <span class="text-slate-300">Dashboard</span>
    </div>

    <!-- Header -->
    <section class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div class="space-y-1">
        <p class="text-xs text-slate-400">Employer dashboard</p>
        <h1 id="employer-dashboard-title" class="text-2xl font-bold tracking-tight text-slate-50 sm:text-3xl">
          Welcome, Employer üëã
        </h1>
        <p class="text-sm text-slate-400">
          Manage your job posts and review student applications in one place.
        </p>
      </div>
      <div class="flex flex-wrap items-center gap-3 text-xs">
        <div class="flex items-center gap-2 rounded-2xl border border-slate-800 bg-slate-900/80 px-3 py-2">
          <div id="employer-avatar-initials"
            class="flex h-8 w-8 items-center justify-center rounded-full bg-indigo-500 text-xs font-semibold">
            EM
          </div>
          <div class="leading-tight">
            <p id="employer-name-line" class="font-semibold text-slate-100">
              Your company
            </p>
            <p id="employer-subtitle-line" class="text-[11px] text-slate-400">
              City ¬∑ hiring students and graduates
            </p>
          </div>
        </div>
        <button id="btn-edit-company"
          class="rounded-full bg-slate-900/80 px-3 py-2 text-[11px] font-semibold text-slate-200 ring-1 ring-slate-700 hover:bg-slate-900 hover:ring-indigo-400">
          Edit company profile
        </button>
      </div>
    </section>

    <!-- Stats -->
    <section class="mt-6 grid gap-4 text-xs md:grid-cols-3">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 shadow-lg shadow-slate-900/70">
        <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">
          Active job posts
        </p>
        <p id="stat-active-jobs" class="mt-2 text-2xl font-bold text-slate-50">0</p>
        <p class="mt-1 text-[11px] text-slate-400">
          Based on your posted jobs
        </p>
      </div>
      <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 shadow-lg shadow-slate-900/70">
        <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">
          Total applications
        </p>
        <p id="stat-total-apps" class="mt-2 text-2xl font-bold text-slate-50">0</p>
        <p class="mt-1 text-[11px] text-slate-400">
          Across all your jobs
        </p>
      </div>
      <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 shadow-lg shadow-slate-900/70">
        <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">
          Upcoming Interviews
        </p>
        <p id="stat-interviews" class="mt-2 text-2xl font-bold text-slate-50">0</p>
        <p class="mt-1 text-[11px] text-slate-400">
          Scheduled interviews
        </p>
        <a href="employer-interviews.html" class="mt-2 inline-block text-[11px] text-indigo-300 hover:text-indigo-200">
          View all ‚Üí
        </a>
      </div>
    </section>

    <!-- Main layout -->
    <section class="mt-8 grid gap-6 md:grid-cols-[minmax(0,1.7fr),minmax(0,1fr)]">
      <!-- LEFT -->
      <div class="space-y-4">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <h2 class="text-sm font-semibold text-slate-50">My job posts</h2>
            <p class="text-xs text-slate-400">
              Manage roles and see how many students applied.
            </p>
          </div>
          <div class="flex flex-wrap gap-2 text-xs">
            <button id="btn-post-job"
              class="rounded-full bg-indigo-500 px-4 py-2 text-[11px] font-semibold text-white shadow-md shadow-indigo-500/40 hover:bg-indigo-400">
              + Post new job
            </button>
          </div>
        </div>

        <!-- ‚úÖ Dynamic job posts list -->
        <div id="employer-jobs-list"
          class="space-y-3 rounded-3xl border border-slate-800 bg-slate-900/80 p-4 shadow-xl shadow-slate-900/70 text-xs">
          <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 text-[11px] text-slate-400">
            Loading your jobs...
          </div>
        </div>

        <!-- Recent activity -->
        <div class="rounded-3xl border border-slate-800 bg-slate-900/80 p-4 shadow-xl shadow-slate-900/70 text-xs">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-50">Recent activity</h2>
            <span class="text-[11px] text-slate-400">Latest updates</span>
          </div>
          <ul id="recent-activity-list" class="mt-3 space-y-2 text-[11px] text-slate-300">
            <li>‚Ä¢ Loading activity...</li>
            <!-- Example of interview update -->
            <li>‚Ä¢ Interview scheduled with <span class="text-indigo-200">Student A</span> for <span class="text-indigo-200">Frontend Developer</span></li>
          </ul>
        </div>
      </div>

      <!-- RIGHT -->
      <aside class="space-y-4">
        <!-- Funnel overview -->
        <div class="rounded-3xl border border-slate-800 bg-slate-900/80 p-4 shadow-xl shadow-slate-900/70 text-xs">
          <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-400">
            Hiring funnel overview
          </p>
          <div class="mt-3 space-y-3">
            <div class="flex items-center justify-between">
              <span>Applications received</span>
              <span id="funnel-received" class="font-semibold text-slate-100">0</span>
            </div>
            <div class="flex items-center justify-between">
              <span>In review</span>
              <span id="funnel-review" class="font-semibold text-slate-100">0</span>
            </div>
            <div class="flex items-center justify-between">
              <span>Interviews</span>
              <span id="funnel-interviews" class="font-semibold text-slate-100">0</span>
            </div>
            <div class="flex items-center justify-between">
              <span>Offers made</span>
              <span id="funnel-offers" class="font-semibold text-slate-100">0</span>
            </div>
          </div>
        </div>

        <!-- Hiring tips -->
        <div
          class="rounded-3xl border border-slate-800 bg-slate-900/80 p-4 text-xs text-slate-300 shadow-xl shadow-slate-900/70">
          <p class="text-[11px] font-semibold uppercase tracking-wide text-indigo-300">
            Tip for better student hires
          </p>
          <p class="mt-1">
            Be explicit about what students will learn, not only what they must already know.
          </p>
          <ul class="mt-2 space-y-1.5">
            <li>‚Ä¢ Mention tech stack and mentorship.</li>
            <li>‚Ä¢ Keep assignments short and fair for students.</li>
            <li>‚Ä¢ Provide feedback when possible.</li>
          </ul>
        </div>
      </aside>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="border-t border-slate-800 bg-slate-950/90">
    <div
      class="mx-auto flex max-w-6xl flex-col gap-3 px-4 py-5 text-xs text-slate-500 md:flex-row md:items-center md:justify-between">
      <p>¬© 2025 UniTalent. All rights reserved.</p>
      <div class="flex flex-wrap gap-4">
        <a href="index.html#about" class="hover:text-indigo-300">About</a>
        <a href="contact.html" class="hover:text-indigo-300">Contact</a>
        <span>Terms ¬∑ Privacy</span>
      </div>
    </div>
  </footer>

  <!-- ‚úÖ JS: employer dashboard behaviour -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const API = "http://localhost:3000";

      // -------------------------
      // Storage helper
      // -------------------------
      const storeGet = (key) =>
        localStorage.getItem(key) ?? sessionStorage.getItem(key);

      // -------------------------
      // Auth helpers
      // -------------------------
      function readUniTalentAuth() {
        const token = storeGet('unitalent_token');
        const userRaw = storeGet('unitalent_user');

        if (!token || !userRaw) return { token: null, user: null };

        try {
          return { token, user: JSON.parse(userRaw) };
        } catch {
          localStorage.removeItem('unitalent_token');
          localStorage.removeItem('unitalent_user');
          sessionStorage.removeItem('unitalent_token');
          sessionStorage.removeItem('unitalent_user');
          return { token: null, user: null };
        }
      }

      function requireEmployerPage() {
        const { token, user } = readUniTalentAuth();

        if (!token || !user) {
          window.location.href = 'employer-login.html';
          return null;
        }

        if (user.role !== 'EMPLOYER') {
          window.location.href =
            user.role === 'STUDENT' ? 'student-login.html' : 'employer-login.html';
          return null;
        }

        return { token, user };
      }

      // -------------------------
      // HARD ROLE GUARD
      // -------------------------
      const auth = requireEmployerPage();
      if (!auth) return;
      const { token, user } = auth;

      // -------- Helpers --------
      const $ = (id) => document.getElementById(id);

      function notify(msg) {
        if (typeof toast !== 'undefined') {
          toast.error(msg);
        } else {
          alert(msg);
        }
      }

      function escapeHtml(str = '') {
        return String(str)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      }

      async function apiGet(path) {
        const res = await fetch(`${API}${path}`, {
          headers: { 
            'Authorization': 'Bearer ' + token,
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          },
          cache: 'no-store'
        });
        const data = await res.json().catch(() => null);

        if (!res.ok) {
          const msg = data?.message || `Request failed (${res.status})`;
          throw new Error(msg);
        }
        return data;
      }

      function initialsFromName(name) {
        const trimmed = String(name || '').trim();
        if (!trimmed) return 'EM';
        const initials = trimmed
          .split(' ')
          .filter(Boolean)
          .map(p => p[0])
          .join('')
          .slice(0, 2)
          .toUpperCase();
        return initials || 'EM';
      }

      function studentName(app) {
        const fn = app?.student?.firstName;
        const ln = app?.student?.lastName;
        const full = [fn, ln].filter(Boolean).join(' ');
        return full || app?.student?.email || 'Student';
      }

      // -------- Display name --------
      const storedName = storeGet('unitalent_employer_name');
      const fallbackFullName =
        [user.firstName, user.lastName].filter(Boolean).join(' ') || user.email;

      const displayName = storedName || fallbackFullName || 'Employer';

      const pill = $('nav-employer-pill');
      const title = $('employer-dashboard-title');
      const nameLine = $('employer-name-line');
      const subtitleLine = $('employer-subtitle-line');
      const avatar = $('employer-avatar-initials');

      if (pill) pill.textContent = `${displayName} ¬∑ Employer`;
      if (title) title.textContent = `Welcome, ${displayName} üëã`;
      if (nameLine) nameLine.textContent = displayName;

      const cityStored = storeGet('unitalent_employer_city');
      if (subtitleLine) {
        subtitleLine.textContent = cityStored
          ? `${cityStored} ¬∑ hiring students and graduates`
          : 'City ¬∑ hiring students and graduates';
      }

      if (avatar) avatar.textContent = initialsFromName(displayName);

      // -------- LOGOUT --------
      const logoutBtn = $('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          localStorage.removeItem('unitalent_token');
          localStorage.removeItem('unitalent_user');
          sessionStorage.removeItem('unitalent_token');
          sessionStorage.removeItem('unitalent_user');

          const keys = [
            'unitalent_student_name',
            'unitalent_student_email',
            'unitalent_student_username',
            'unitalent_employer_name',
            'unitalent_employer_bin',
            'unitalent_employer_city',
            'unitalent_employer_size'
          ];

          keys.forEach(k => {
            localStorage.removeItem(k);
            sessionStorage.removeItem(k);
          });

          window.location.href = 'index.html';
        });
      }

      // Navigation buttons
      const postBtn = $('btn-post-job');
      if (postBtn) {
        postBtn.addEventListener('click', () => {
          window.location.href = 'employer-new-job.html';
        });
      }

      const editCompanyBtn = $('btn-edit-company');
      if (editCompanyBtn) {
        editCompanyBtn.addEventListener('click', () => {
          window.location.href = 'employer-profile.html';
        });
      }

      // -------- DATA LOAD --------
      const statActive = $('stat-active-jobs');
      const statApps = $('stat-total-apps');
      const statInterviews = $('stat-interviews');

      const funnelReceived = $('funnel-received');
      const funnelReview = $('funnel-review');
      const funnelInterviews = $('funnel-interviews');
      const funnelOffers = $('funnel-offers');

      const jobsListEl = $('employer-jobs-list');
      const activityListEl = $('recent-activity-list');

      let myJobs = [];
      let myApps = [];

      try {
        myJobs = await apiGet('/api/jobs/my');
      } catch (e) {
        console.warn('Failed to load employer jobs:', e.message);
        myJobs = [];
      }

      try {
        myApps = await apiGet('/api/applications/employer/my');
      } catch (e) {
        console.warn('Failed to load employer applications:', e.message);
        myApps = [];
      }

      // -------- Stats fill --------
      if (statActive) statActive.textContent = String(myJobs.length);
      if (statApps) statApps.textContent = String(myApps.length);
      
      // Load upcoming interviews count
      async function loadUpcomingInterviewsCount() {
        try {
          if (statInterviews) statInterviews.textContent = "0";
          const data = await apiGet('/api/applications/employer/interviews/upcoming/count');
          const count = typeof data.count === 'number' ? data.count : 0;
          if (statInterviews) statInterviews.textContent = String(count);
        } catch (err) {
          console.warn('Failed to load upcoming interviews count:', err.message);
          if (statInterviews) statInterviews.textContent = "0";
        }
      }
      
      // Load funnel stats
      async function loadFunnelStats() {
        try {
          if (funnelReceived) funnelReceived.textContent = "0";
          if (funnelReview) funnelReview.textContent = "0";
          if (funnelInterviews) funnelInterviews.textContent = "0";
          if (funnelOffers) funnelOffers.textContent = "0";

          const data = await apiGet('/api/applications/employer/funnel');
          
          if (funnelReceived) funnelReceived.textContent = String(data.applicationsReceived || 0);
          if (funnelReview) funnelReview.textContent = String(data.inReview || 0);
          if (funnelInterviews) funnelInterviews.textContent = String(data.interviews || 0);
          if (funnelOffers) funnelOffers.textContent = String(data.offersMade || 0);
        } catch (err) {
          console.warn('Failed to load funnel stats:', err.message);
          if (funnelReceived) funnelReceived.textContent = "0";
          if (funnelReview) funnelReview.textContent = "0";
          if (funnelInterviews) funnelInterviews.textContent = "0";
          if (funnelOffers) funnelOffers.textContent = "0";
        }
      }
      
      loadUpcomingInterviewsCount();
      loadFunnelStats();

      // Funnel stats are loaded separately via loadFunnelStats()

      // ----------------------------
      // COUNT APPLICATIONS PER JOB
      // ----------------------------
      function countAppsForJob(jobId) {
        if (!Array.isArray(myApps)) return 0;
        return myApps.filter(a => a?.jobId === jobId).length;
      }

      // ----------------------------
      // RENDER JOB ITEM (WITH DELETE)
      // ----------------------------
      function renderJobItem(job) {
        const title = escapeHtml(job?.title || 'Untitled job');
        const location = escapeHtml(job?.location || 'Location not specified');
        const salary = escapeHtml(job?.salary || 'Salary not specified');
        const appsCount = countAppsForJob(job.id);

        return `
      <article class="flex flex-col gap-3 border-b border-slate-800 pb-3 last:border-b-0 last:pb-0
        md:flex-row md:items-center md:justify-between">

        <div>
          <p class="text-[11px] uppercase tracking-wide text-emerald-400">Active ¬∑ Job</p>
          <h3 class="mt-1 text-sm font-semibold text-slate-50">${title}</h3>
          <p class="text-[11px] text-slate-400">${location} ¬∑ ${salary}</p>
          <p class="mt-1 text-[11px] text-slate-300">
            ${escapeHtml((job?.description || '').slice(0, 160))}
            ${(job?.description || '').length > 160 ? '...' : ''}
          </p>
        </div>

        <div class="flex flex-col items-end gap-1 text-[11px]">
          <p class="text-slate-300">
            <span class="font-semibold text-slate-100">${appsCount}</span> applications
          </p>
          <p class="text-slate-400">Track applicants in detail</p>

          <div class="mt-1 flex gap-2">

            <a class="rounded-full bg-indigo-500 px-3 py-1.5 font-semibold text-white hover:bg-indigo-400"
               href="employer-applicants.html?jobId=${encodeURIComponent(job.id)}">
              View applicants
            </a>

            <a class="rounded-full bg-slate-900 px-3 py-1.5 text-slate-200 ring-1 ring-slate-700 hover:ring-indigo-400"
               href="employer-edit-job.html?id=${encodeURIComponent(job.id)}">
              Edit
            </a>

            <button
              data-delete="${job.id}"
              class="rounded-full bg-rose-600 px-3 py-1.5 text-white hover:bg-rose-500">
              Delete
            </button>

          </div>
        </div>
      </article>
    `;
      }

      // ----------------------------
      // RENDER JOB LIST
      // ----------------------------
      if (jobsListEl) {
        if (!Array.isArray(myJobs) || myJobs.length === 0) {
          jobsListEl.innerHTML = `
        <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 text-[11px] text-slate-400">
          You have no job posts yet. Click <b>‚ÄúPost new job‚Äù</b> to create your first listing.
        </div>`;
        } else {
          jobsListEl.innerHTML = myJobs.map(renderJobItem).join('');
        }
      }

      // ----------------------------
      // DELETE JOB HANDLER
      // ----------------------------
      document.addEventListener("click", async (e) => {
        const btn = e.target.closest("button[data-delete]");
        if (!btn) return;

        const jobId = btn.getAttribute("data-delete");

        if (!confirm("Are you sure you want to delete this job?")) return;

        try {
          const res = await fetch(`${API}/api/jobs/${jobId}`, {
            method: "DELETE",
            headers: {
              "Authorization": "Bearer " + token
            }
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            alert(data.message || "Failed to delete job");
            return;
          }

          alert("Job deleted successfully.");
          window.location.reload();

        } catch (err) {
          console.error(err);
          alert("Error deleting job.");
        }
      });

      // ----------------------------
      // RECENT ACTIVITY
      // ----------------------------
      if (activityListEl) {
        if (!Array.isArray(myApps) || myApps.length === 0) {
          activityListEl.innerHTML = `
        <li>‚Ä¢ No recent activity yet.</li>
        <li>‚Ä¢ Once students apply, updates will appear here.</li>`;
        } else {
          const top = myApps.slice(0, 3);
          activityListEl.innerHTML = top.map(app => {
            const sName = escapeHtml(studentName(app));
            const jTitle = escapeHtml(app?.job?.title || `Job #${app?.jobId}`);
            return `‚Ä¢ New application for <span class="text-slate-100">${jTitle}</span> 
                from <span class="text-indigo-200">${sName}</span>.`;
          }).map(li => `<li>${li}</li>`).join('');
        }
      }

    });
  </script>

  <!-- Shared auth (auto navbar guards based on data-guard) -->
  <script src="js/toast.js"></script>
  <script type="module" src="js/auth.js"></script>

</body>

</html>

